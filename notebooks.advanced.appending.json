{"version":2,"kind":"Notebook","sha256":"cfb2cd2a40738fda1f3cf29605fe45e9be39b96b54574b40f164dba8d35a867f","slug":"notebooks.advanced.appending","location":"/notebooks/advanced/appending.ipynb","dependencies":[],"frontmatter":{"title":"Appending to Kerchunk references","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"kerchunk-cookbook","language":"python"},"authors":[{"nameParsed":{"literal":"Norland Raphael Hagen","given":"Norland Raphael","family":"Hagen"},"name":"Norland Raphael Hagen","id":"contributors-myst-generated-uid-0"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/kerchunk-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/kerchunk-cookbook/blob/main/notebooks/advanced/appending.ipynb","exports":[{"format":"ipynb","filename":"appending.ipynb","url":"/kerchunk-cookbook/build/appending-df8ee382d8a597dd2d7d110c7a16a86c.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hCYIQ1NylP"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"Q9iJan0rgI"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this tutorial we’ll show how to append to a pre-existing Kerchunk reference. We’ll use the same datasets as in the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gyle5yxX8b"},{"type":"link","url":"/notebooks/generating-references/netcdf","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"NetCDF reference generation","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JfZ5fiBf2D"}],"urlSource":"../generating_references/NetCDF.ipynb","dataUrl":"/notebooks.generating-references.netcdf.json","internal":true,"protocol":"file","key":"r1Eq6ZhjJJ"},{"type":"text","value":" example.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wB5Jb4Gze5"}],"key":"iZgzwmpwNp"},{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"HJfV8bBXOW"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"VJEAQYrHQn"},{"type":"table","position":{"start":{"line":6,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"DPE4PXPJ1u"}],"key":"psJ7AWNiqB"},{"type":"tableCell","header":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"XNyqo8TuWa"}],"key":"rHYO5hjUVv"},{"type":"tableCell","header":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"DVrYyQWTaA"}],"key":"MP9jAHZYAM"}],"key":"h2nYzJaH2x"},{"type":"tableRow","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"link","url":"../foundations/kerchunk_basics","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Kerchunk Basics","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"LHGE1Yhbd6"}],"urlSource":"../foundations/kerchunk_basics","key":"oU5QuZgpc5"}],"key":"KjRqauZfgg"},{"type":"tableCell","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"vrcmxuaLfz"}],"key":"x3UfuUEASD"},{"type":"tableCell","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Yh10Fk4ASS"}],"key":"gxZqPSOPiV"}],"key":"BlYvnQ99Cn"},{"type":"tableRow","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"link","url":"../foundations/kerchunk_multi_file","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Multiple Files and Kerchunk","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"nzUgK8etTz"}],"urlSource":"../foundations/kerchunk_multi_file","key":"mxC830d8Tg"}],"key":"ygmRqwzSr1"},{"type":"tableCell","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"RpJkxPDf7Y"}],"key":"hhcHnmcCgn"},{"type":"tableCell","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"Zuxx0gfvlP"}],"key":"bU62EbiXhf"}],"key":"g4rSbKerbb"},{"type":"tableRow","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"link","url":"../case_studies/ARG_Weather.ipynb","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Multi-File Datasets with Kerchunk","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"gKeCFEqzeG"}],"urlSource":"../case_studies/ARG_Weather.ipynb","key":"Ee30M9mfUH"}],"key":"QOaoO6no07"},{"type":"tableCell","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"VP0D1bPY78"}],"key":"mWSfNa6eNB"},{"type":"tableCell","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"IO/Visualization","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"b7dZAEoktc"}],"key":"g4npBXXvGo"}],"key":"qn2VUvxYAC"}],"key":"iUVBlsu3Is"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"strong","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"fR5IuzDAY1"}],"key":"CfilRqDtAd"},{"type":"text","value":": 45 minutes","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"MqtntUK2nZ"}],"key":"FAA6eYAK5h"}],"key":"pWIBQK7gv5"},{"type":"thematicBreak","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"UZIBRnotXB"}],"key":"p2MqVD1Xt7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"S6c4lmOkYe"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"u12eYh42Bs"}],"key":"jeTBArc66T"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import logging\nfrom tempfile import TemporaryDirectory\n\nimport dask\nimport fsspec\nimport ujson\nimport xarray as xr\nfrom distributed import Client\nfrom kerchunk.combine import MultiZarrToZarr\nfrom kerchunk.hdf import SingleHdf5ToZarr","key":"zWTqIH3PHJ"},{"type":"output","id":"G75jfWfVyqnRobWnXHx3N","data":[],"key":"mzRTfqwVqh"}],"key":"ylM2LYwjR0"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create Input File List","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hPFhOVUFxI"}],"identifier":"create-input-file-list","label":"Create Input File List","html_id":"create-input-file-list","implicit":true,"key":"Q0jCQf3K1H"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Here we are using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ww2iZ6Qvki"},{"type":"inlineCode","value":"fsspec's","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jczUjcfIvC"},{"type":"text","value":" glob functionality along with the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NTPOThJJ9V"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"*","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fJUZ5BwFEy"}],"key":"cRxS623Twc"},{"type":"text","value":" wildcard operator and some string slicing to grab a list of NetCDF files from a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qXbIqfWwLW"},{"type":"inlineCode","value":"s3","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"AGnVR2tZsh"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ccRCzEmkJy"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tU71NOEmhg"},{"type":"text","value":" filesystem.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jOBDaVQ6B5"}],"key":"elVq72MkKF"}],"key":"d0nPRtzRLS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Initiate fsspec filesystems for reading\nfs_read = fsspec.filesystem(\"s3\", anon=True, skip_instance_cache=True)\n\nfiles_paths = fs_read.glob(\n    \"s3://smn-ar-wrf/DATA/WRF/DET/2022/12/31/12/WRFDETAR_01H_20221231_12_*\"\n)\n\n# Here we prepend the prefix 's3://', which points to AWS.\nfile_pattern = sorted([\"s3://\" + f for f in files_paths])","key":"zQQFEUptjh"},{"type":"output","id":"KvrUff_oNPryj9K3Gp2Ke","data":[],"key":"MivMJoXXkV"}],"key":"HWNNxtahJI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# This dictionary will be passed as kwargs to `fsspec`. For more details, check out the\n# `foundations/kerchunk_basics` notebook.\nso = dict(mode=\"rb\", anon=True, default_fill_cache=False, default_cache_type=\"first\")\n\n# We are creating a temporary directory to store the .json reference files\n# Alternately, you could write these to cloud storage.\ntd = TemporaryDirectory()\ntemp_dir = td.name","key":"jgEQtFrZfY"},{"type":"output","id":"McmwRhgA_pnk1i2QmfJBn","data":[],"key":"eLjstzshlh"}],"key":"hfee6SLIRC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Start a Dask Client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KH0z9vrcDa"}],"identifier":"start-a-dask-client","label":"Start a Dask Client","html_id":"start-a-dask-client","implicit":true,"key":"UuS8RnpHvv"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To parallelize the creation of our reference files, we will use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pTsyx9ElbM"},{"type":"inlineCode","value":"Dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qoPn98RmX3"},{"type":"text","value":". For a detailed guide on how to use Dask and Kerchunk, see the Foundations notebook: ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VeZOZjwDCn"},{"type":"link","url":"../foundations/kerchunk_dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Kerchunk and Dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WQUSaWnnHk"}],"urlSource":"../foundations/kerchunk_dask","key":"OdLpehn8t8"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"elhyEfquR6"}],"key":"bPWGAgSybu"}],"key":"LHGOxJk2zS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client = Client(n_workers=8, silence_logs=logging.ERROR)\nclient","key":"wmPxwWp2Hh"},{"type":"output","id":"dXdEeiqjkKfVamLLM-_yO","data":[{"output_type":"stream","name":"stderr","text":"/home/runner/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/distributed/node.py:187: UserWarning: Port 8787 is already in use.\nPerhaps you already have a cluster running?\nHosting the HTTP server on port 42755 instead\n  warnings.warn(\n"},{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"<Client: 'tcp://127.0.0.1:43959' processes=8 threads=8, memory=15.62 GiB>","content_type":"text/plain"},"text/html":{"content":"<div>\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\"> </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px;\">Client</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Client-3bc3bed8-6115-11f0-908b-7c1e52b3574b</p>\n        <table style=\"width: 100%; text-align: left;\">\n\n        <tr>\n        \n            <td style=\"text-align: left;\"><strong>Connection method:</strong> Cluster object</td>\n            <td style=\"text-align: left;\"><strong>Cluster type:</strong> distributed.LocalCluster</td>\n        \n        </tr>\n\n        \n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:42755/status\" target=\"_blank\">http://127.0.0.1:42755/status</a>\n                </td>\n                <td style=\"text-align: left;\"></td>\n            </tr>\n        \n\n        </table>\n\n        \n            <button style=\"margin-bottom: 12px;\" data-commandlinker-command=\"dask:populate-and-launch-layout\" data-commandlinker-args='{\"url\": \"http://127.0.0.1:42755/status\" }'>\n                Launch dashboard in JupyterLab\n            </button>\n        \n\n        \n            <details>\n            <summary style=\"margin-bottom: 20px;\"><h3 style=\"display: inline;\">Cluster Info</h3></summary>\n            <div class=\"jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output\">\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\">\n    </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px; margin-top: 0px;\">LocalCluster</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">64c73035</p>\n        <table style=\"width: 100%; text-align: left;\">\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:42755/status\" target=\"_blank\">http://127.0.0.1:42755/status</a>\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Workers:</strong> 8\n                </td>\n            </tr>\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Total threads:</strong> 8\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Total memory:</strong> 15.62 GiB\n                </td>\n            </tr>\n            \n            <tr>\n    <td style=\"text-align: left;\"><strong>Status:</strong> running</td>\n    <td style=\"text-align: left;\"><strong>Using processes:</strong> True</td>\n</tr>\n\n            \n        </table>\n\n        <details>\n            <summary style=\"margin-bottom: 20px;\">\n                <h3 style=\"display: inline;\">Scheduler Info</h3>\n            </summary>\n\n            <div style=\"\">\n    <div>\n        <div style=\"width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;\"> </div>\n        <div style=\"margin-left: 48px;\">\n            <h3 style=\"margin-bottom: 0px;\">Scheduler</h3>\n            <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Scheduler-7bd13be4-21eb-4097-a00b-34a443336e4a</p>\n            <table style=\"width: 100%; text-align: left;\">\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Comm:</strong> tcp://127.0.0.1:43959\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Workers:</strong> 0 \n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:42755/status\" target=\"_blank\">http://127.0.0.1:42755/status</a>\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total threads:</strong> 0\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Started:</strong> Just now\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total memory:</strong> 0 B\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n\n    <details style=\"margin-left: 48px;\">\n        <summary style=\"margin-bottom: 20px;\">\n            <h3 style=\"display: inline;\">Workers</h3>\n        </summary>\n\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 0</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:45111\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:43911/status\" target=\"_blank\">http://127.0.0.1:43911/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:43753\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-hxaifi4q\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 1</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:40851\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:41293/status\" target=\"_blank\">http://127.0.0.1:41293/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:35589\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-ex6m0iuy\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 2</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:43843\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:37885/status\" target=\"_blank\">http://127.0.0.1:37885/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:32779\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-itcvsgk_\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 3</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:41263\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:35067/status\" target=\"_blank\">http://127.0.0.1:35067/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:39871\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-7wsizlo0\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 4</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:44087\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:36523/status\" target=\"_blank\">http://127.0.0.1:36523/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:41199\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-xc1witq8\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 5</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:43027\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:41313/status\" target=\"_blank\">http://127.0.0.1:41313/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:45609\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-5kd5yhd7\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 6</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:45045\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:46781/status\" target=\"_blank\">http://127.0.0.1:46781/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:44951\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-soa5k0db\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 7</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:34799\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:34447/status\" target=\"_blank\">http://127.0.0.1:34447/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:36947\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-rhb6i0j4\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n\n    </details>\n</div>\n\n        </details>\n    </div>\n</div>\n            </details>\n        \n\n    </div>\n</div>","content_type":"text/html"}}}],"key":"pLnUaj063N"}],"key":"jQZmbYIC6o"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ye1lgFP7dR"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aCLbgcIyPX"},{"type":"text","value":" reference file for the first 24 hours","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nWa4lokbh0"}],"identifier":"create-a-kerchunk-reference-file-for-the-first-24-hours","label":"Create a Kerchunk reference file for the first 24 hours","html_id":"create-a-kerchunk-reference-file-for-the-first-24-hours","implicit":true,"key":"KFaCckWgxK"}],"key":"pLmfF43eyo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"first_24_hrs = file_pattern[:24]","key":"p7Bfwis4eW"},{"type":"output","id":"vYVn-E1FwD26DKpjXNxis","data":[],"key":"Gnvc9Er8HL"}],"key":"MV7PzSaMI6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Use Kerchunk's `SingleHdf5ToZarr` method to create a `Kerchunk` index from\n# a NetCDF file.\n\n\ndef generate_json_reference(fil, output_dir: str):\n    with fs_read.open(fil, **so) as infile:\n        h5chunks = SingleHdf5ToZarr(infile, fil, inline_threshold=300)\n        fname = fil.split(\"/\")[-1].strip(\".nc\")\n        outf = f\"{output_dir}/{fname}.json\"\n        with open(outf, \"wb\") as f:\n            f.write(ujson.dumps(h5chunks.translate()).encode())\n        return outf\n\n\n# Generate Dask Delayed objects\ntasks = [dask.delayed(generate_json_reference)(fil, temp_dir) for fil in first_24_hrs]","key":"CJi5x33P2I"},{"type":"output","id":"9wFgvpVZwMmcd5UMOwGos","data":[],"key":"ixhAvQnxVb"}],"key":"sKmf5iC0LB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Start parallel processing\nimport warnings\n\nwarnings.filterwarnings(\"ignore\")\ndask.compute(tasks)","key":"nPEIYyvenL"},{"type":"output","id":"jjV7n9MhFkm-tEAuZVzm7","data":[{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/plain":{"content":"(['/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_000.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_001.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_002.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_003.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_004.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_005.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_006.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_007.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_008.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_009.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_010.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_011.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_012.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_013.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_014.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_015.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_016.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_017.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_018.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_019.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_020.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_021.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_022.json',\n  '/tmp/tmpya3qf8a6/WRFDETAR_01H_20221231_12_023.json'],)","content_type":"text/plain"}}}],"key":"PUUDpubg5d"}],"key":"UQPvj0T2BF"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combine .json ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XrhUAwjx1S"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m1NPmfdtsA"},{"type":"text","value":" reference files and write a combined ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gvMRaZBo7g"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KcNmB7EoX9"},{"type":"text","value":" index","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KfKC0MUDSI"}],"identifier":"combine-json-kerchunk-reference-files-and-write-a-combined-kerchunk-index","label":"Combine .json Kerchunk reference files and write a combined Kerchunk index","html_id":"combine-json-kerchunk-reference-files-and-write-a-combined-kerchunk-index","implicit":true,"key":"ykurfTICUA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In the following cell, we are combining all the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jCn8i7myUs"},{"type":"inlineCode","value":".json","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"narDvrtnLb"},{"type":"text","value":" reference files that were generated above into a single reference file and writing that file to disk.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QZCPb4s32B"}],"key":"dZRhaSARef"}],"key":"wsAAHRgnhL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create a list of reference json files\noutput_files = [\n    f\"{temp_dir}/{f.strip('.nc').split('/')[-1]}.json\" for f in first_24_hrs\n]\n\n# combine individual references into single consolidated reference\nmzz = MultiZarrToZarr(\n    output_files,\n    concat_dims=[\"time\"],\n    identical_dims=[\"y\", \"x\"],\n    remote_protocol=\"s3\",\n    remote_options={\"anon\": True},\n    coo_map={\"time\": \"cf:time\"},\n)\n# save translate reference in memory for later visualization\nmulti_kerchunk = mzz.translate()\n\n# Write kerchunk .json record.\noutput_fname = \"ARG_combined.json\"\nwith open(f\"{output_fname}\", \"wb\") as f:\n    f.write(ujson.dumps(multi_kerchunk).encode())","key":"M1NxjKmTKs"},{"type":"output","id":"UFWB_fEEgy40MSa_ZFmhu","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mRuntimeError\u001b[39m                              Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[8]\u001b[39m\u001b[32m, line 16\u001b[39m\n\u001b[32m      7\u001b[39m mzz = MultiZarrToZarr(\n\u001b[32m      8\u001b[39m     output_files,\n\u001b[32m      9\u001b[39m     concat_dims=[\u001b[33m\"\u001b[39m\u001b[33mtime\u001b[39m\u001b[33m\"\u001b[39m],\n\u001b[32m   (...)\u001b[39m\u001b[32m     13\u001b[39m     coo_map={\u001b[33m\"\u001b[39m\u001b[33mtime\u001b[39m\u001b[33m\"\u001b[39m: \u001b[33m\"\u001b[39m\u001b[33mcf:time\u001b[39m\u001b[33m\"\u001b[39m},\n\u001b[32m     14\u001b[39m )\n\u001b[32m     15\u001b[39m \u001b[38;5;66;03m# save translate reference in memory for later visualization\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m16\u001b[39m multi_kerchunk = \u001b[43mmzz\u001b[49m\u001b[43m.\u001b[49m\u001b[43mtranslate\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     18\u001b[39m \u001b[38;5;66;03m# Write kerchunk .json record.\u001b[39;00m\n\u001b[32m     19\u001b[39m output_fname = \u001b[33m\"\u001b[39m\u001b[33mARG_combined.json\u001b[39m\u001b[33m\"\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/kerchunk/combine.py:647\u001b[39m, in \u001b[36mMultiZarrToZarr.translate\u001b[39m\u001b[34m(self, filename, storage_options)\u001b[39m\n\u001b[32m    645\u001b[39m     \u001b[38;5;28mself\u001b[39m.first_pass()\n\u001b[32m    646\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[32m2\u001b[39m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mself\u001b[39m.done:\n\u001b[32m--> \u001b[39m\u001b[32m647\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mstore_coords\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    648\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[32m3\u001b[39m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mself\u001b[39m.done:\n\u001b[32m    649\u001b[39m     \u001b[38;5;28mself\u001b[39m.second_pass()\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/kerchunk/combine.py:473\u001b[39m, in \u001b[36mMultiZarrToZarr.store_coords\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    470\u001b[39m \u001b[38;5;28mself\u001b[39m.out.update(kv)\n\u001b[32m    471\u001b[39m logger.debug(\u001b[33m\"\u001b[39m\u001b[33mWritten coordinates\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m--> \u001b[39m\u001b[32m473\u001b[39m metadata = \u001b[43masyncio\u001b[49m\u001b[43m.\u001b[49m\u001b[43mrun\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_read_meta_files\u001b[49m\u001b[43m(\u001b[49m\u001b[43mm\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43m.zgroup\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43m.zattrs\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m)\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    474\u001b[39m \u001b[38;5;28mself\u001b[39m.out.update(metadata)\n\u001b[32m    475\u001b[39m logger.debug(\u001b[33m\"\u001b[39m\u001b[33mWritten global metadata\u001b[39m\u001b[33m\"\u001b[39m)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/asyncio/runners.py:191\u001b[39m, in \u001b[36mrun\u001b[39m\u001b[34m(main, debug, loop_factory)\u001b[39m\n\u001b[32m    161\u001b[39m \u001b[38;5;250m\u001b[39m\u001b[33;03m\"\"\"Execute the coroutine and return the result.\u001b[39;00m\n\u001b[32m    162\u001b[39m \n\u001b[32m    163\u001b[39m \u001b[33;03mThis function runs the passed coroutine, taking care of\u001b[39;00m\n\u001b[32m   (...)\u001b[39m\u001b[32m    187\u001b[39m \u001b[33;03m    asyncio.run(main())\u001b[39;00m\n\u001b[32m    188\u001b[39m \u001b[33;03m\"\"\"\u001b[39;00m\n\u001b[32m    189\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m events._get_running_loop() \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m    190\u001b[39m     \u001b[38;5;66;03m# fail fast with short traceback\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m191\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mRuntimeError\u001b[39;00m(\n\u001b[32m    192\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33masyncio.run() cannot be called from a running event loop\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m    194\u001b[39m \u001b[38;5;28;01mwith\u001b[39;00m Runner(debug=debug, loop_factory=loop_factory) \u001b[38;5;28;01mas\u001b[39;00m runner:\n\u001b[32m    195\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m runner.run(main)\n\n\u001b[31mRuntimeError\u001b[39m: asyncio.run() cannot be called from a running event loop","ename":"RuntimeError","evalue":"asyncio.run() cannot be called from a running event loop"}],"key":"EzPjJ2xWmD"}],"key":"Rd7azsqKVi"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Append references for the next 24 hours","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AfMycZvJZf"}],"identifier":"append-references-for-the-next-24-hours","label":"Append references for the next 24 hours","html_id":"append-references-for-the-next-24-hours","implicit":true,"key":"xHGBP77Jy9"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"We’ll now append the references for the next 24 hours. First, we create an individual temporary reference file for each input data file. Then,\nwe load the original references and append the new references.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ghx6wNmSEv"}],"key":"RwjhYTWrEG"}],"key":"YcCoalAU5L"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# First generate the individual reference files to be appended\n\nsecond_24_hrs = file_pattern[24:48]\n\n# Generate Dask Delayed objects\ntasks = [dask.delayed(generate_json_reference)(fil, temp_dir) for fil in second_24_hrs]\n\n# Generate reference files for the individual NetCDF files\ndask.compute(tasks)","key":"Rmznfx9HS6"},{"type":"output","id":"Scac2Ddc7_6K55HmFddQ3","data":[],"key":"EYnhPj2I8l"}],"key":"tPhLXe1Ad8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Load the original references\nfs_local = fsspec.filesystem(\"file\")\narchive = ujson.load(fs_local.open(output_fname))","key":"WA0MQrqvwg"},{"type":"output","id":"aGJw6dEVtLZAIvXqJqsVB","data":[],"key":"bmZcUZDD7K"}],"key":"jCwxVPhE0R"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create a list of individual reference files to append to the combined reference\noutput_files = [\n    f\"{temp_dir}/{f.strip('.nc').split('/')[-1]}.json\" for f in second_24_hrs\n]\n\n# Append to the existing reference file\nmzz = MultiZarrToZarr.append(\n    output_files,\n    original_refs=archive,\n    concat_dims=[\"time\"],\n    identical_dims=[\"y\", \"x\"],\n    remote_protocol=\"s3\",\n    remote_options={\"anon\": True},\n    coo_map={\"time\": \"cf:time\"},\n)\n\nmulti_kerchunk = mzz.translate()\n\n# Write kerchunk .json record.\noutput_fname = \"ARG_combined.json\"\nwith open(f\"{output_fname}\", \"wb\") as f:\n    f.write(ujson.dumps(multi_kerchunk).encode())","key":"zHflhSg76O"},{"type":"output","id":"rA6LA-2XGiCdj5OKCVOFI","data":[],"key":"YiIDlmxDrj"}],"key":"dwwaxGxpb2"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Opening Reference Dataset with Fsspec and Xarray","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qeNRJ8fQRc"}],"identifier":"opening-reference-dataset-with-fsspec-and-xarray","label":"Opening Reference Dataset with Fsspec and Xarray","html_id":"opening-reference-dataset-with-fsspec-and-xarray","implicit":true,"key":"YTRfG0yfrl"}],"key":"hjiHSlJCzJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"storage_options = {\n    \"remote_protocol\": \"s3\",\n    \"skip_instance_cache\": True,\n    \"remote_options\": {\"anon\": True}\n}  # options passed to fsspec\nopen_dataset_options = {\"chunks\": {}}  # opens passed to xarray\n\nds = xr.open_dataset(\n    \"ARG_combined.json\",\n    engine=\"kerchunk\",\n    storage_options=storage_options,\n    open_dataset_options=open_dataset_options,\n)","key":"uvnnkaVgfT"},{"type":"output","id":"g3qD9T39J0mfaFw1gtFir","data":[],"key":"gggu9LxhNT"}],"key":"m9G0oenEoY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds\n","key":"ZwjDCByJxE"},{"type":"output","id":"4HRnjkakGgJG9u9lwS6Ci","data":[],"key":"qm3vCEKp1N"}],"key":"ws9YBSDIAp"}],"key":"vOfBYneKP6"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Store virtual datasets as Kerchunk Parquet references","url":"/notebooks/advanced/parquet-reference-storage","group":"Advanced"},"next":{"title":"NetCDF","url":"/notebooks/generating-references/netcdf","group":"Generating Reference Files"}}},"domain":"http://localhost:3000"}
{"version":2,"kind":"Notebook","sha256":"ff787c20d68345d7ccadb63990b5203aec321df6bca402604afcbfe6f60ec7ac","slug":"notebooks.advanced.parquet-reference-storage","location":"/notebooks/advanced/Parquet_Reference_Storage.ipynb","dependencies":[],"frontmatter":{"title":"Store virtual datasets as Kerchunk Parquet references","content_includes_title":true,"kernelspec":{"name":"python3","display_name":"kerchunk-cookbook","language":"python"},"authors":[{"nameParsed":{"literal":"Norland Raphael Hagen","given":"Norland Raphael","family":"Hagen"},"name":"Norland Raphael Hagen","id":"contributors-myst-generated-uid-0"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/kerchunk-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/kerchunk-cookbook/blob/main/notebooks/advanced/Parquet_Reference_Storage.ipynb","thumbnail":"/kerchunk-cookbook/build/95b6b03e3a18dfba219c0d718515c49f.svg","exports":[{"format":"ipynb","filename":"Parquet_Reference_Storage.ipynb","url":"/kerchunk-cookbook/build/Parquet_Reference_St-e6f68a54a3568c2de663309bd2fad074.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"image","url":"/kerchunk-cookbook/build/95b6b03e3a18dfba219c0d718515c49f.svg","alt":"Parquet Logo","width":400,"key":"GiPeHO7OLr","urlSource":"https://upload.wikimedia.org/wikipedia/commons/4/47/Apache_Parquet_logo.svg"}],"key":"bhE2q7fEjE"}],"key":"dGXpjefS1a"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Store virtual datasets as Kerchunk Parquet references","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Vcpb2vTSm4"}],"identifier":"store-virtual-datasets-as-kerchunk-parquet-references","label":"Store virtual datasets as Kerchunk Parquet references","html_id":"store-virtual-datasets-as-kerchunk-parquet-references","implicit":true,"key":"CfTLfyRNtA"}],"key":"Z3jU3NdsfU"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WnzvmFmsyq"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"Ivpn9VdgQS"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this notebook we will cover how to store virtual datasets as Kerchunk Parquet references instead of Kerchunk JSON references. For large virtual datasets, using Parquet should have performance implications as the overall reference file size should be smaller and the memory overhead of combining the reference files should be lower.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cKsH4aJDnu"}],"key":"WR2wB8sqOp"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"This notebook builds upon the ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"yeP1ux1Oy7"},{"type":"link","url":"notebooks/foundations/01_kerchunk_basics.ipynb","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Kerchunk Basics","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"dZ9jLG9x4x"}],"urlSource":"notebooks/foundations/01_kerchunk_basics.ipynb","key":"LJ401YDBDe"},{"type":"text","value":", ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"pPeIVgTPjT"},{"type":"link","url":"notebooks/foundations/02_kerchunk_multi_file.ipynb","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Multi-File Datasets with Kerchunk","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ufaxHZM5id"}],"urlSource":"notebooks/foundations/02_kerchunk_multi_file.ipynb","key":"m8uh9fRwWT"},{"type":"text","value":" and the ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"i6KU1HwsOS"},{"type":"link","url":"notebooks/foundations/03_kerchunk_dask.ipynb","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Kerchunk and Dask","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Al8iUGmTsg"}],"urlSource":"notebooks/foundations/03_kerchunk_dask.ipynb","key":"T4QEbhiQx7"},{"type":"text","value":" notebooks.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"nY1fcLXiqV"}],"key":"V5IYKfEnsJ"},{"type":"heading","depth":2,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"yOJ35IuwtC"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"m4RF6SNhzi"},{"type":"table","position":{"start":{"line":9,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"IOdqI8kRG1"}],"key":"n9Dbvr3eTT"},{"type":"tableCell","header":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"CO7eMcwkE7"}],"key":"pd3OnAwCXw"},{"type":"tableCell","header":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"AM0keteaPS"}],"key":"Cs9CekMmxJ"}],"key":"JeRQbpFJp3"},{"type":"tableRow","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"link","url":"/notebooks/foundations/kerchunk-basics","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Basics of virtual Zarr stores","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"DfHOhzj9oS"}],"urlSource":"../foundations/01_kerchunk_basics.ipynb","dataUrl":"/notebooks.foundations.kerchunk-basics.json","internal":true,"protocol":"file","key":"ExoY4mCnlu"}],"key":"LGzEojDIB9"},{"type":"tableCell","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"SUI21sLKbF"}],"key":"s4q8f8Zc9w"},{"type":"tableCell","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"popC7WfCSc"}],"key":"qJXIRXyoif"}],"key":"B8ujPWLCyP"},{"type":"tableRow","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"link","url":"/notebooks/foundations/kerchunk-multi-file","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Multi-file virtual datasets with VirtualiZarr","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"DPN0f1EyHT"}],"urlSource":"../foundations/02_kerchunk_multi_file.ipynb","dataUrl":"/notebooks.foundations.kerchunk-multi-file.json","internal":true,"protocol":"file","key":"JKrZeOyE8m"}],"key":"AFqpNWM2zW"},{"type":"tableCell","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"aNHZChAHez"}],"key":"qHUqV3XJhC"},{"type":"tableCell","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"MkLM8pPCBc"}],"key":"pPnGfJKNiL"}],"key":"hsscWbPfVk"},{"type":"tableRow","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"link","url":"/notebooks/foundations/kerchunk-dask","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Parallel virtual dataset creation with VirtualiZarr, Kerchunk, and Dask","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"BzzgIPqQl0"}],"urlSource":"../foundations/03_kerchunk_dask","dataUrl":"/notebooks.foundations.kerchunk-dask.json","internal":true,"protocol":"file","key":"IqVEmgXZus"}],"key":"zYLZNLix8l"},{"type":"tableCell","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"eWFB4C2H1X"}],"key":"yq2LbcRne3"},{"type":"tableCell","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"IhnT5d3pRH"}],"key":"hJ8McQmb99"}],"key":"g7VwsNvTry"},{"type":"tableRow","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray/xarray-intro.html","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Introduction to Xarray","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"VgWa5NOVdt"}],"urlSource":"https://foundations.projectpythia.org/core/xarray/xarray-intro.html","key":"vu1p9TUhI8"}],"key":"NcvYKTWG9r"},{"type":"tableCell","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"GWqdqcunwz"}],"key":"BM7lIz0Zix"},{"type":"tableCell","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"IO/Visualization","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"cqYbjueH2T"}],"key":"z91gxHuVsJ"}],"key":"res8lDqAcO"}],"key":"d7bG1cuupY"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"strong","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"LVttDEOTJe"}],"key":"rwNwIuX2uN"},{"type":"text","value":": 30 minutes","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"dCv5N8FmUn"}],"key":"DDrXMU7MC3"}],"key":"gtAIO4gbPG"},{"type":"thematicBreak","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"RaVHjnsNwS"}],"key":"ljIH6cbxeR"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vjhqEgzXPr"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"GGJOSjRvbz"}],"key":"QSLdYRRELl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import logging\n\nimport dask\nimport fsspec\nimport xarray as xr\nfrom distributed import Client\nfrom virtualizarr import open_virtual_dataset","key":"l6y2JsEtaZ"},{"type":"output","id":"EuZgTpU8vKkJVZCGa95wP","data":[],"key":"KpF1DkMXmB"}],"key":"RjLqtgnAdO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Setting up the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oSoYpPRg6c"},{"type":"inlineCode","value":"Dask","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"or5xOUl2Av"},{"type":"text","value":" Client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Pgy6UFBi7a"}],"identifier":"setting-up-the-dask-client","label":"Setting up the Dask Client","html_id":"setting-up-the-dask-client","implicit":true,"key":"RxDXIx02T1"}],"key":"BW67a1GerA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client = Client(n_workers=8, silence_logs=logging.ERROR)\nclient","key":"cIOz6AzO5o"},{"type":"output","id":"1NW0onBw44D4UBQbjFoxC","data":[{"output_type":"stream","name":"stderr","text":"/home/runner/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/distributed/node.py:187: UserWarning: Port 8787 is already in use.\nPerhaps you already have a cluster running?\nHosting the HTTP server on port 43797 instead\n  warnings.warn(\n"},{"output_type":"execute_result","execution_count":2,"metadata":{},"data":{"text/plain":{"content":"<Client: 'tcp://127.0.0.1:42793' processes=8 threads=8, memory=15.62 GiB>","content_type":"text/plain"},"text/html":{"content":"<div>\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\"> </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px;\">Client</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Client-3cead1e2-61de-11f0-9094-000d3a58c2dd</p>\n        <table style=\"width: 100%; text-align: left;\">\n\n        <tr>\n        \n            <td style=\"text-align: left;\"><strong>Connection method:</strong> Cluster object</td>\n            <td style=\"text-align: left;\"><strong>Cluster type:</strong> distributed.LocalCluster</td>\n        \n        </tr>\n\n        \n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:43797/status\" target=\"_blank\">http://127.0.0.1:43797/status</a>\n                </td>\n                <td style=\"text-align: left;\"></td>\n            </tr>\n        \n\n        </table>\n\n        \n            <button style=\"margin-bottom: 12px;\" data-commandlinker-command=\"dask:populate-and-launch-layout\" data-commandlinker-args='{\"url\": \"http://127.0.0.1:43797/status\" }'>\n                Launch dashboard in JupyterLab\n            </button>\n        \n\n        \n            <details>\n            <summary style=\"margin-bottom: 20px;\"><h3 style=\"display: inline;\">Cluster Info</h3></summary>\n            <div class=\"jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output\">\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\">\n    </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px; margin-top: 0px;\">LocalCluster</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">58e5eff3</p>\n        <table style=\"width: 100%; text-align: left;\">\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:43797/status\" target=\"_blank\">http://127.0.0.1:43797/status</a>\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Workers:</strong> 8\n                </td>\n            </tr>\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Total threads:</strong> 8\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Total memory:</strong> 15.62 GiB\n                </td>\n            </tr>\n            \n            <tr>\n    <td style=\"text-align: left;\"><strong>Status:</strong> running</td>\n    <td style=\"text-align: left;\"><strong>Using processes:</strong> True</td>\n</tr>\n\n            \n        </table>\n\n        <details>\n            <summary style=\"margin-bottom: 20px;\">\n                <h3 style=\"display: inline;\">Scheduler Info</h3>\n            </summary>\n\n            <div style=\"\">\n    <div>\n        <div style=\"width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;\"> </div>\n        <div style=\"margin-left: 48px;\">\n            <h3 style=\"margin-bottom: 0px;\">Scheduler</h3>\n            <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Scheduler-f9421c6e-f8fa-4d8b-aaa1-22498a39bff9</p>\n            <table style=\"width: 100%; text-align: left;\">\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Comm:</strong> tcp://127.0.0.1:42793\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Workers:</strong> 0 \n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:43797/status\" target=\"_blank\">http://127.0.0.1:43797/status</a>\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total threads:</strong> 0\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Started:</strong> Just now\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total memory:</strong> 0 B\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n\n    <details style=\"margin-left: 48px;\">\n        <summary style=\"margin-bottom: 20px;\">\n            <h3 style=\"display: inline;\">Workers</h3>\n        </summary>\n\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 0</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:46253\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:46397/status\" target=\"_blank\">http://127.0.0.1:46397/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:42467\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-4ogg99m9\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 1</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:39937\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:44013/status\" target=\"_blank\">http://127.0.0.1:44013/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:46847\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-oz2nwetl\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 2</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:46523\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:37393/status\" target=\"_blank\">http://127.0.0.1:37393/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:45481\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-4n2rkqwe\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 3</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:36093\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:42933/status\" target=\"_blank\">http://127.0.0.1:42933/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:46287\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-494puwqq\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 4</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:42927\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:38407/status\" target=\"_blank\">http://127.0.0.1:38407/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:38321\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-cffhga8r\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 5</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:41077\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:38713/status\" target=\"_blank\">http://127.0.0.1:38713/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:41607\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-r4pkopnw\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 6</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:39705\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:35307/status\" target=\"_blank\">http://127.0.0.1:35307/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:32907\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-korizpzn\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 7</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:42697\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:43595/status\" target=\"_blank\">http://127.0.0.1:43595/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:41139\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-10dsoxsj\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n\n    </details>\n</div>\n\n        </details>\n    </div>\n</div>\n            </details>\n        \n\n    </div>\n</div>","content_type":"text/html"}}}],"key":"lMuGJjFgCD"}],"key":"rhSKtNYKzv"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create Input File List","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oPuAx6LZOk"}],"identifier":"create-input-file-list","label":"Create Input File List","html_id":"create-input-file-list","implicit":true,"key":"O6qxTZUD1j"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Here we are using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"THtKtjzawW"},{"type":"inlineCode","value":"fsspec's","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KjunqjZXac"},{"type":"text","value":" glob functionality along with the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TkwV1weLjb"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"*","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tbtDI8x2Qk"}],"key":"gQ5dWzWWDO"},{"type":"text","value":" wildcard operator and some string slicing to grab a list of NetCDF files from a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vH2HDgd8IL"},{"type":"inlineCode","value":"s3","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"P1rXDvGMyD"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vO4WRNUYGp"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TXjdto0G7Q"},{"type":"text","value":" filesystem.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HSrwHRf3fO"}],"key":"P9bwMMEpFv"}],"key":"xKEPRJbWhE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Initiate fsspec filesystems for reading\nfs_read = fsspec.filesystem(\"s3\", anon=True, skip_instance_cache=True)\n\nfiles_paths = fs_read.glob(\"s3://smn-ar-wrf/DATA/WRF/DET/2022/12/31/12/*\")\n\n# Here we prepend the prefix 's3://', which points to AWS.\nfiles_paths = sorted([\"s3://\" + f for f in files_paths])","key":"mH05bYxW4L"},{"type":"output","id":"10mWAP9vE5wBkXH5MQ2H1","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mAttributeError\u001b[39m                            Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[3]\u001b[39m\u001b[32m, line 4\u001b[39m\n\u001b[32m      1\u001b[39m \u001b[38;5;66;03m# Initiate fsspec filesystems for reading\u001b[39;00m\n\u001b[32m      2\u001b[39m fs_read = fsspec.filesystem(\u001b[33m\"\u001b[39m\u001b[33ms3\u001b[39m\u001b[33m\"\u001b[39m, anon=\u001b[38;5;28;01mTrue\u001b[39;00m, skip_instance_cache=\u001b[38;5;28;01mTrue\u001b[39;00m)\n\u001b[32m----> \u001b[39m\u001b[32m4\u001b[39m files_paths = \u001b[43mfs_read\u001b[49m\u001b[43m.\u001b[49m\u001b[43mglob\u001b[49m\u001b[43m(\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43ms3://smn-ar-wrf/DATA/WRF/DET/2022/12/31/12/*\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m)\u001b[49m\n\u001b[32m      6\u001b[39m \u001b[38;5;66;03m# Here we prepend the prefix 's3://', which points to AWS.\u001b[39;00m\n\u001b[32m      7\u001b[39m files_paths = \u001b[38;5;28msorted\u001b[39m([\u001b[33m\"\u001b[39m\u001b[33ms3://\u001b[39m\u001b[33m\"\u001b[39m + f \u001b[38;5;28;01mfor\u001b[39;00m f \u001b[38;5;129;01min\u001b[39;00m files_paths])\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:118\u001b[39m, in \u001b[36msync_wrapper.<locals>.wrapper\u001b[39m\u001b[34m(*args, **kwargs)\u001b[39m\n\u001b[32m    115\u001b[39m \u001b[38;5;129m@functools\u001b[39m.wraps(func)\n\u001b[32m    116\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mwrapper\u001b[39m(*args, **kwargs):\n\u001b[32m    117\u001b[39m     \u001b[38;5;28mself\u001b[39m = obj \u001b[38;5;129;01mor\u001b[39;00m args[\u001b[32m0\u001b[39m]\n\u001b[32m--> \u001b[39m\u001b[32m118\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43msync\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mloop\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mfunc\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43margs\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:103\u001b[39m, in \u001b[36msync\u001b[39m\u001b[34m(loop, func, timeout, *args, **kwargs)\u001b[39m\n\u001b[32m    101\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m FSTimeoutError \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mreturn_result\u001b[39;00m\n\u001b[32m    102\u001b[39m \u001b[38;5;28;01melif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(return_result, \u001b[38;5;167;01mBaseException\u001b[39;00m):\n\u001b[32m--> \u001b[39m\u001b[32m103\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m return_result\n\u001b[32m    104\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m    105\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m return_result\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:56\u001b[39m, in \u001b[36m_runner\u001b[39m\u001b[34m(event, coro, result, timeout)\u001b[39m\n\u001b[32m     54\u001b[39m     coro = asyncio.wait_for(coro, timeout=timeout)\n\u001b[32m     55\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m---> \u001b[39m\u001b[32m56\u001b[39m     result[\u001b[32m0\u001b[39m] = \u001b[38;5;28;01mawait\u001b[39;00m coro\n\u001b[32m     57\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mException\u001b[39;00m \u001b[38;5;28;01mas\u001b[39;00m ex:\n\u001b[32m     58\u001b[39m     result[\u001b[32m0\u001b[39m] = ex\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:807\u001b[39m, in \u001b[36mAsyncFileSystem._glob\u001b[39m\u001b[34m(self, path, maxdepth, **kwargs)\u001b[39m\n\u001b[32m    804\u001b[39m     \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m    805\u001b[39m         depth = \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m807\u001b[39m allpaths = \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._find(\n\u001b[32m    808\u001b[39m     root, maxdepth=depth, withdirs=\u001b[38;5;28;01mTrue\u001b[39;00m, detail=\u001b[38;5;28;01mTrue\u001b[39;00m, **kwargs\n\u001b[32m    809\u001b[39m )\n\u001b[32m    811\u001b[39m pattern = glob_translate(path + (\u001b[33m\"\u001b[39m\u001b[33m/\u001b[39m\u001b[33m\"\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m ends_with_sep \u001b[38;5;28;01melse\u001b[39;00m \u001b[33m\"\u001b[39m\u001b[33m\"\u001b[39m))\n\u001b[32m    812\u001b[39m pattern = re.compile(pattern)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/s3fs/core.py:558\u001b[39m, in \u001b[36mS3FileSystem._find\u001b[39m\u001b[34m(self, path, maxdepth, withdirs, detail)\u001b[39m\n\u001b[32m    556\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\u001b[33m\"\u001b[39m\u001b[33mCannot traverse all of S3\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m    557\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m maxdepth:\n\u001b[32m--> \u001b[39m\u001b[32m558\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28msuper\u001b[39m()._find(\n\u001b[32m    559\u001b[39m         bucket + \u001b[33m\"\u001b[39m\u001b[33m/\u001b[39m\u001b[33m\"\u001b[39m + key, maxdepth=maxdepth, withdirs=withdirs, detail=detail\n\u001b[32m    560\u001b[39m     )\n\u001b[32m    561\u001b[39m \u001b[38;5;66;03m# TODO: implement find from dircache, if all listings are present\u001b[39;00m\n\u001b[32m    562\u001b[39m \u001b[38;5;66;03m# if refresh is False:\u001b[39;00m\n\u001b[32m    563\u001b[39m \u001b[38;5;66;03m#     out = incomplete_tree_dirs(self.dircache, path)\u001b[39;00m\n\u001b[32m   (...)\u001b[39m\u001b[32m    568\u001b[39m \u001b[38;5;66;03m#         return super().find(path)\u001b[39;00m\n\u001b[32m    569\u001b[39m \u001b[38;5;66;03m#     # else: we refresh anyway, having at least two missing trees\u001b[39;00m\n\u001b[32m    570\u001b[39m out = \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._lsdir(path, delimiter=\u001b[33m\"\u001b[39m\u001b[33m\"\u001b[39m)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:847\u001b[39m, in \u001b[36mAsyncFileSystem._find\u001b[39m\u001b[34m(self, path, maxdepth, withdirs, **kwargs)\u001b[39m\n\u001b[32m    843\u001b[39m detail = kwargs.pop(\u001b[33m\"\u001b[39m\u001b[33mdetail\u001b[39m\u001b[33m\"\u001b[39m, \u001b[38;5;28;01mFalse\u001b[39;00m)\n\u001b[32m    845\u001b[39m \u001b[38;5;66;03m# Add the root directory if withdirs is requested\u001b[39;00m\n\u001b[32m    846\u001b[39m \u001b[38;5;66;03m# This is needed for posix glob compliance\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m847\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m withdirs \u001b[38;5;129;01mand\u001b[39;00m path != \u001b[33m\"\u001b[39m\u001b[33m\"\u001b[39m \u001b[38;5;129;01mand\u001b[39;00m \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._isdir(path):\n\u001b[32m    848\u001b[39m     out[path] = \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._info(path)\n\u001b[32m    850\u001b[39m \u001b[38;5;66;03m# async for?\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/s3fs/core.py:1021\u001b[39m, in \u001b[36mS3FileSystem._isdir\u001b[39m\u001b[34m(self, path)\u001b[39m\n\u001b[32m   1018\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;01mFalse\u001b[39;00m\n\u001b[32m   1020\u001b[39m \u001b[38;5;66;03m# This only returns things within the path and NOT the path object itself\u001b[39;00m\n\u001b[32m-> \u001b[39m\u001b[32m1021\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28mbool\u001b[39m(\u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._lsdir(path))\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/s3fs/core.py:509\u001b[39m, in \u001b[36mS3FileSystem._lsdir\u001b[39m\u001b[34m(self, path, refresh, max_items, delimiter)\u001b[39m\n\u001b[32m    507\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m    508\u001b[39m     logger.debug(\u001b[33m\"\u001b[39m\u001b[33mGet directory listing page for \u001b[39m\u001b[38;5;132;01m%s\u001b[39;00m\u001b[33m\"\u001b[39m % path)\n\u001b[32m--> \u001b[39m\u001b[32m509\u001b[39m     \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._connect()\n\u001b[32m    510\u001b[39m     pag = \u001b[38;5;28mself\u001b[39m.s3.get_paginator(\u001b[33m\"\u001b[39m\u001b[33mlist_objects_v2\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m    511\u001b[39m     config = {}\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/s3fs/core.py:365\u001b[39m, in \u001b[36mS3FileSystem._connect\u001b[39m\u001b[34m(self, refresh, kwargs)\u001b[39m\n\u001b[32m    363\u001b[39m     config_kwargs[\u001b[33m\"\u001b[39m\u001b[33msignature_version\u001b[39m\u001b[33m\"\u001b[39m] = UNSIGNED\n\u001b[32m    364\u001b[39m conf = AioConfig(**config_kwargs)\n\u001b[32m--> \u001b[39m\u001b[32m365\u001b[39m \u001b[38;5;28mself\u001b[39m.session = \u001b[43maiobotocore\u001b[49m\u001b[43m.\u001b[49m\u001b[43mAioSession\u001b[49m(**\u001b[38;5;28mself\u001b[39m.kwargs)\n\u001b[32m    366\u001b[39m s3creator = \u001b[38;5;28mself\u001b[39m.session.create_client(\n\u001b[32m    367\u001b[39m     \u001b[33m\"\u001b[39m\u001b[33ms3\u001b[39m\u001b[33m\"\u001b[39m, config=conf, **init_kwargs, **client_kwargs\n\u001b[32m    368\u001b[39m )\n\u001b[32m    369\u001b[39m \u001b[38;5;28mself\u001b[39m._s3creator = s3creator\n\n\u001b[31mAttributeError\u001b[39m: module 'aiobotocore' has no attribute 'AioSession'","ename":"AttributeError","evalue":"module 'aiobotocore' has no attribute 'AioSession'"}],"key":"gKNQ2DWdBB"}],"key":"GomyBi0Ewm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Subset the Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XIXttaIQiB"}],"identifier":"subset-the-data","label":"Subset the Data","html_id":"subset-the-data","implicit":true,"key":"m8WTn1Jx2J"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"To speed up our example, lets take a subset of the year of data.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"FHFCqLPAKX"}],"key":"UHrTe8VPBL"}],"key":"aZTUfQMQsB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# If the subset_flag == True (default), the list of input files will\n# be subset to speed up the processing\nsubset_flag = True\nif subset_flag:\n    files_paths = files_paths[0:4]","key":"y5KGa3ctcC"},{"type":"output","id":"2xqGCagdFG_vYOM9fHYqK","data":[],"key":"HuDAxc4uhu"}],"key":"L4AyAtaaeF"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Generate Lazy References","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oaCmPZW2TG"}],"identifier":"generate-lazy-references","label":"Generate Lazy References","html_id":"generate-lazy-references","implicit":true,"key":"M8FssLrXlp"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Here we create a function to generate a list of Dask delayed objects.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"EwPALWFpdu"}],"key":"eFSxjCtZMn"}],"key":"netsvNPIDr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def generate_virtual_dataset(file, storage_options):\n    return open_virtual_dataset(\n        file, indexes={}, reader_options={\"storage_options\": storage_options}\n    )\n\n\nstorage_options = dict(anon=True, default_fill_cache=False, default_cache_type=\"first\")\n# Generate Dask Delayed objects\ntasks = [\n    dask.delayed(generate_virtual_dataset)(file, storage_options)\n    for file in files_paths\n]","key":"rO1Q5RDDFi"},{"type":"output","id":"FbBizwUcyqlHXhH1gL6hX","data":[],"key":"RAL26TEX7f"}],"key":"vB8IDGoRSX"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Start the Dask Processing","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RgNMZlXadq"}],"identifier":"start-the-dask-processing","label":"Start the Dask Processing","html_id":"start-the-dask-processing","implicit":true,"key":"YTCRTY8Ffa"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"To view the processing you can view it in real-time on the Dask Dashboard. ex: ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"bjEPNlJC0v"},{"type":"link","url":"http://127.0.0.1:8787/status","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"http://​127​.0​.0​.1:8787​/status","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"yLX5NvDbpo"}],"urlSource":"http://127.0.0.1:8787/status","key":"DvQOdNVISk"}],"key":"eDeCCundzE"}],"key":"wyhL1RWE48"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"virtual_datasets = list(dask.compute(*tasks))","key":"mWWEPUgVgA"},{"type":"output","id":"ptvrZV8t8DxXnnKMY1r3C","data":[],"key":"ABFeSRwTXf"}],"key":"cKd7I34zN0"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combine virtual datasets using VirtualiZarr","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Uzr1KiAVky"}],"identifier":"combine-virtual-datasets-using-virtualizarr","label":"Combine virtual datasets using VirtualiZarr","html_id":"combine-virtual-datasets-using-virtualizarr","implicit":true,"key":"opdlb0mqOw"}],"key":"pxjzPi1n70"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"combined_vds = xr.combine_nested(\n    virtual_datasets, concat_dim=[\"time\"], coords=\"minimal\", compat=\"override\"\n)\ncombined_vds","key":"o6CWJq08I6"},{"type":"output","id":"tv6FcA50K9V0fanPolB_z","data":[],"key":"jNhEELfIiO"}],"key":"vQNwrjIk1V"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Write the virtual dataset to a Kerchunk Parquet reference","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SsIi4jOZts"}],"identifier":"write-the-virtual-dataset-to-a-kerchunk-parquet-reference","label":"Write the virtual dataset to a Kerchunk Parquet reference","html_id":"write-the-virtual-dataset-to-a-kerchunk-parquet-reference","implicit":true,"key":"MIDL72H3V3"}],"key":"yW7HhZchGC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"combined_vds.virtualize.to_kerchunk(\"combined.parq\", format=\"parquet\")","key":"oCprZVn8UD"},{"type":"output","id":"lAKIH9gr9l5KDnubUZV-_","data":[],"key":"mrtOFwiihC"}],"key":"NEXTC7etkN"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Shutdown the Dask cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cj9U9HrLqi"}],"identifier":"shutdown-the-dask-cluster","label":"Shutdown the Dask cluster","html_id":"shutdown-the-dask-cluster","implicit":true,"key":"WsOEflR7FC"}],"key":"hr6OMkh9Hh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.shutdown()","key":"MqrFkVpFa6"},{"type":"output","id":"4_vAvaZXXq4RE3eTboUfM","data":[],"key":"LT1LR1i8Bx"}],"key":"OSm0wqWDvQ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load kerchunked dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QKh73L7DBb"}],"identifier":"load-kerchunked-dataset","label":"Load kerchunked dataset","html_id":"load-kerchunked-dataset","implicit":true,"key":"lcVlm89jkA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Next we initiate a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YOzCOQ4zyY"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ICY0AByxjA"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GHQK2cqk4z"},{"type":"inlineCode","value":"ReferenceFileSystem","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jpLc0K1ejU"},{"type":"text","value":".\nWe need to pass:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vmOazOxhot"}],"key":"yTLoV98Syg"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"The name of the parquet store","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"hxKRZeVN00"}],"key":"gxiCNaODJ2"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"The remote protocol (This is the protocol of the input file urls)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"K9TwAkP0vi"}],"key":"G56R5uc1Xn"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"The target protocol (","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"XztzqzFMJb"},{"type":"inlineCode","value":"file","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"uua3aRjlEz"},{"type":"text","value":" since we saved our parquet store locally).","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"WL5GlH1IVg"}],"key":"bJkPXUm7UI"}],"key":"TEtivsacSq"}],"key":"ZBuZcWB3sz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"storage_options = {\n    \"remote_protocol\": \"s3\",\n    \"skip_instance_cache\": True,\n    \"remote_options\": {\"anon\": True},\n    \"target_protocol\": \"file\",\n    \"lazy\": True,\n}  # options passed to fsspec\nopen_dataset_options = {\"chunks\": {}}  # opens passed to xarray\n\nds = xr.open_dataset(\n    \"combined.parq\",\n    engine=\"kerchunk\",\n    storage_options=storage_options,\n    open_dataset_options=open_dataset_options,\n)\nds","key":"MQR1m1orNr"},{"type":"output","id":"0QveaPj5c2BabrJ4ey8XY","data":[],"key":"JL2GDuJ8gZ"}],"key":"W0Mf4n0dI7"}],"key":"Od67kFSQXG"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Parallel virtual dataset creation with VirtualiZarr, Kerchunk, and Dask","url":"/notebooks/foundations/kerchunk-dask","group":"Foundations"},"next":{"title":"Appending to Kerchunk references","url":"/notebooks/advanced/appending","group":"Advanced"}}},"domain":"http://localhost:3000"}
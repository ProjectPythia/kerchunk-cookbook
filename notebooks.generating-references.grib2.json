{"version":2,"kind":"Notebook","sha256":"d28fe614e8cb8b667d08be49d4772c48b5a3d6369135f19aaf112b72c5b6cb49","slug":"notebooks.generating-references.grib2","location":"/notebooks/generating_references/GRIB2.ipynb","dependencies":[],"frontmatter":{"title":"GRIB2","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"literal":"Norland Raphael Hagen","given":"Norland Raphael","family":"Hagen"},"name":"Norland Raphael Hagen","id":"contributors-myst-generated-uid-0"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/kerchunk-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/kerchunk-cookbook/blob/main/notebooks/generating_references/GRIB2.ipynb","thumbnail":"/kerchunk-cookbook/build/GRIB2-1ca3d3da39ad4209ebbc67104c091657.png","exports":[{"format":"ipynb","filename":"GRIB2.ipynb","url":"/kerchunk-cookbook/build/GRIB2-ff0b25c0ff4fc24dec6db27d2531b2a7.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Generating Kerchunk References from GRIB2 files","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"RHNQhtyfiF"}],"key":"Zn5FuzOrLH"}],"key":"Lhs7cKX9sD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"image","url":"/kerchunk-cookbook/build/GRIB2-1ca3d3da39ad4209ebbc67104c091657.png","alt":"HRRR GRIB2","width":350,"key":"ZEFQnnTyqb","urlSource":"../images/GRIB2.png"}],"key":"xzluNtkeqz"}],"key":"jOClbA6u0C"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AwVzR3f2hE"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"iadfaEZTBU"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Within this notebook, we will cover:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pU4PMj260e"}],"key":"VpJyI4og4o"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Generating a list of GRIB2 files on a remote filesystem using ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"JVsKnvs5Lo"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"tPTpSi6S1g"}],"key":"XgzpiiDYHq"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"How to create reference files of GRIB2 files using ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Iz0cSgexKX"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"f9NhjJhja9"}],"key":"NjCfxLnuQq"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Combining multiple ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"bHYrXXAaKW"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jOBQXc2B0Y"},{"type":"text","value":" reference files using ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Ppn8dX3PgT"},{"type":"inlineCode","value":"MultiZarrToZarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"g4MRN7myBf"}],"key":"Cd3jDMOkX5"}],"key":"DNVDJZHraC"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"This notebook shares many similarities with the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"vS5vJbx4AE"},{"type":"link","url":"../foundations/kerchunk_multi_file.ipynb","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Multi-File Datasets with Kerchunk","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"e0CLmQBkl7"}],"urlSource":"../foundations/kerchunk_multi_file.ipynb","key":"luYuc3Ln4N"},{"type":"text","value":" and the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"rwvIRE6TG4"},{"type":"link","url":"../case_studies/ARG_Weather.ipynb","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"NetCDF/HDF5 Argentinian Weather Dataset Case Study","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"VEU02u6yJr"}],"urlSource":"../case_studies/ARG_Weather.ipynb","key":"pYIiELHjgA"},{"type":"text","value":", however this case studies examines another data format and uses ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"C7a3zYPROa"},{"type":"inlineCode","value":"kerchunk.scan_grib","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"Orcuh7NDMs"},{"type":"text","value":" to create reference files.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"UNbojlcZbi"}],"key":"gDSQNfevwK"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"This notebook borrows heavily from this ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"ZCSWK7Bcrh"},{"type":"link","url":"https://gist.github.com/peterm790/92eb1df3d58ba41d3411f8a840be2452","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"GIST","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"gYssqUvVzW"}],"urlSource":"https://gist.github.com/peterm790/92eb1df3d58ba41d3411f8a840be2452","key":"AUIAMfrWMz"},{"type":"text","value":" created by ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"iBJcSHUaRF"},{"type":"link","url":"https://gist.github.com/peterm790","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Peter Marsh","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"KAhxPqo5PG"}],"urlSource":"https://gist.github.com/peterm790","key":"b9x16wxDmI"},{"type":"text","value":".","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"T71n7oDKwg"}],"key":"cyNVvTkaXQ"},{"type":"heading","depth":2,"position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"QdHSqS2J8E"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"XyCQzVFDIz"},{"type":"table","position":{"start":{"line":15,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"fG8mfJpu4X"}],"key":"Wq1lRnr0zN"},{"type":"tableCell","header":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"L2GayXXG5S"}],"key":"rKlvUH5Xp2"},{"type":"tableCell","header":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"pQ61bh3bV9"}],"key":"Gqtjd3w4Vw"}],"key":"Vo9vIq33df"},{"type":"tableRow","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"link","url":"../foundations/kerchunk_basics","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Kerchunk Basics","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"yMduIc9VhO"}],"urlSource":"../foundations/kerchunk_basics","key":"bBbVoXKbnW"}],"key":"t4ubJmWZ6c"},{"type":"tableCell","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"aLPcZSkwep"}],"key":"VTdk4MiiHL"},{"type":"tableCell","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"x2R7V6dRRD"}],"key":"eotzKZbipG"}],"key":"Jce6eOc31R"},{"type":"tableRow","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"link","url":"../foundations/kerchunk_multi_file","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"Multiple Files and Kerchunk","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"c5yh4NuAs6"}],"urlSource":"../foundations/kerchunk_multi_file","key":"lUMTrDByNr"}],"key":"KbvaQpE3Hy"},{"type":"tableCell","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"EolAMBaKfN"}],"key":"HsafcToJO9"},{"type":"tableCell","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"ILZ7brpEZm"}],"key":"mS4aLdmlA6"}],"key":"n2NcYrxkAf"},{"type":"tableRow","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"link","url":"../foundations/kerchunk_dask","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Kerchunk and Dask","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"SCJpTXBFGX"}],"urlSource":"../foundations/kerchunk_dask","key":"BnE2kwBEk7"}],"key":"fsPLgh2Ha9"},{"type":"tableCell","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"naQPnuHXAv"}],"key":"AsN0pLy4Qi"},{"type":"tableCell","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"VSyAb9GEVd"}],"key":"C89cdRWAhf"}],"key":"APLYQA1UhO"},{"type":"tableRow","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray/xarray-intro","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"Introduction to Xarray","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"qCyf2WoD0q"}],"urlSource":"https://foundations.projectpythia.org/core/xarray/xarray-intro","key":"uPvaowCZFq"}],"key":"OSgkYBx5wp"},{"type":"tableCell","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"FV2fGloZsZ"}],"key":"A50FVrc4nA"},{"type":"tableCell","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"text","value":"IO/Visualization","position":{"start":{"line":20,"column":1},"end":{"line":20,"column":1}},"key":"VgwTzNqXpw"}],"key":"MZWOlB6QuU"}],"key":"mlmU4GwL4h"}],"key":"L0m3tZWpdV"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"strong","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"f4BbTdNLda"}],"key":"ZPn1mNl2WT"},{"type":"text","value":": 45 minutes","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"NjZwzBRSyv"}],"key":"JEH773z51b"}],"key":"ZwAy4v9znx"},{"type":"thematicBreak","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"DvEYTIithm"}],"key":"GD4Qhj3JHi"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Motivation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qxTf7FgCqL"}],"identifier":"motivation","label":"Motivation","html_id":"motivation","implicit":true,"key":"bJKqKTixMB"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LBAo5E5bjw"},{"type":"text","value":" supports multiple input file formats. One of these is ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PJhQxf8KYS"},{"type":"inlineCode","value":"GRIB2(GRIdded Information in Binary form)","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WBSh3INHSE"},{"type":"text","value":", which is a binary file format primary used in meteorology and weather datasets. Similar to NetCDF/HDF5, GRIB2 does not support efficient, parallel access. Using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vATlFdx4ts"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zehg52HdUX"},{"type":"text","value":", we can read this legacy format as if it were an ARCO (Analysis-Ready, Cloud-Optimized) data format such as Zarr.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"J0AG9X4w7w"}],"key":"jye92IBff9"}],"key":"E4sgWuzD8b"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"About the Dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VQHa3SXRuL"}],"identifier":"about-the-dataset","label":"About the Dataset","html_id":"about-the-dataset","implicit":true,"key":"gAFpEU9Yau"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ia7RR94WsP"},{"type":"inlineCode","value":"HRRR","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"AXruXQh2RM"},{"type":"text","value":" is a NOAA real-time 3-km resolution, hourly updated, cloud-resolving, convection-allowing atmospheric model, initialized by 3km grids with 3km radar assimilation. Radar data is assimilated in the HRRR every 15 min over a 1-h period adding further detail to that provided by the hourly data assimilation from the 13km radar-enhanced Rapid Refresh.\nNOAA releases a copy of this dataset via the AWS Registry of Open Data.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"w6RYMq8DOX"}],"key":"U6gacl9nvl"}],"key":"QQMrMz0wxO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Flags","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KtTEOfZpW2"}],"identifier":"flags","label":"Flags","html_id":"flags","implicit":true,"key":"LOaonMQdH2"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In the section below, set the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"DlvDfjIODv"},{"type":"inlineCode","value":"subset","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"n4D0Hm1VQm"},{"type":"text","value":" flag to be ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"vlXkKmBnOX"},{"type":"inlineCode","value":"True","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"gHndPD9Zhb"},{"type":"text","value":" (default) or ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"vcx3LlPNQG"},{"type":"inlineCode","value":"False","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"xQeo62wZjU"},{"type":"text","value":" depending if you want this notebook to process the full file list. If set to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"LRzNotMOle"},{"type":"inlineCode","value":"True","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"pgsThcysDz"},{"type":"text","value":", then a subset of the file list will be processed (Recommended)","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"HEWd7l0fNS"}],"key":"K3E91GpMU6"}],"key":"L6bsWzgCol"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"subset_flag = True","key":"DAVlSqqW91"},{"type":"output","id":"WdqZeIE3uj1cXJULT-8g_","data":[],"key":"Lq2lcvO7hq"}],"key":"unRIA7NVGe"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WnrQthR7kh"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"sj2GQIeBDS"}],"key":"eC0a6TEPU1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import glob\nimport logging\nfrom tempfile import TemporaryDirectory\n\nimport dask\nimport fsspec\nimport ujson\nfrom distributed import Client\nfrom kerchunk.combine import MultiZarrToZarr\nfrom kerchunk.grib2 import scan_grib","key":"jqKkg1NDs3"},{"type":"output","id":"-QtUiK5oWN-g_NsSuYGmE","data":[],"key":"FKHAIoPoCP"}],"key":"yXL8eNxZvT"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create Input File List","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A9HOd89mPD"}],"identifier":"create-input-file-list","label":"Create Input File List","html_id":"create-input-file-list","implicit":true,"key":"D1J79RkGoV"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Here we create ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Kcaw2caEY0"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"L6SXiMuNRo"},{"type":"text","value":" files-systems for reading remote files and writing local reference files.\nNext we are using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IGZoSa8O3w"},{"type":"inlineCode","value":"fsspec.glob","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CxfAwCk7BV"},{"type":"text","value":" to retrieve a list of file paths and appending the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"A4W1jdgfQv"},{"type":"inlineCode","value":"s3://","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oTQ0XoHX7g"},{"type":"text","value":" prefix to them.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IwV5P1s83b"}],"key":"YjhFfw4I2k"}],"key":"NqxAD7rcEc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Initiate fsspec filesystems for reading and writing\nfs_read = fsspec.filesystem(\"s3\", anon=True, skip_instance_cache=True)\n\n# retrieve list of available days in archive\ndays_available = fs_read.glob(\"s3://noaa-hrrr-bdp-pds/hrrr.*\")\n\n# Read HRRR GRIB2 files from April 19, 2023\nfiles = fs_read.glob(\"s3://noaa-hrrr-bdp-pds/hrrr.20230419/conus/*wrfsfcf01.grib2\")\n\n# Append s3 prefix for filelist\nfiles = sorted([\"s3://\" + f for f in files])\n\n# If the subset_flag == True (default), the list of input files will be subset to\n# speed up the processing\nif subset_flag:\n    files = files[0:2]","key":"r018Cv76T2"},{"type":"output","id":"hIoZGh5mvsMCQH103Z1Ri","data":[],"key":"CHpTYiLQbR"}],"key":"aouC3m1l9I"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Start a Dask Client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ATG6ajFZYo"}],"identifier":"start-a-dask-client","label":"Start a Dask Client","html_id":"start-a-dask-client","implicit":true,"key":"Tq4pqI4PAc"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To parallelize the creation of our reference files, we will use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LQMNHhbirf"},{"type":"inlineCode","value":"Dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yHhS8s5htq"},{"type":"text","value":". For a detailed guide on how to use Dask and Kerchunk, see the Foundations notebook: ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tCp2yzK8QG"},{"type":"link","url":"../foundations/kerchunk_dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Kerchunk and Dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FFs3q7DIEf"}],"urlSource":"../foundations/kerchunk_dask","key":"YMrCKYQmZv"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IYKJN6LMdJ"}],"key":"eErj1JvVeR"}],"key":"X8BRpAsXnd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client = Client(n_workers=8, silence_logs=logging.ERROR)\nclient","key":"gD9edKNy8d"},{"type":"output","id":"AR-VizJHQ48e5V56zfPFJ","data":[{"output_type":"stream","name":"stderr","text":"/home/runner/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/distributed/node.py:187: UserWarning: Port 8787 is already in use.\nPerhaps you already have a cluster running?\nHosting the HTTP server on port 37315 instead\n  warnings.warn(\n"},{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"<Client: 'tcp://127.0.0.1:39075' processes=8 threads=8, memory=15.62 GiB>","content_type":"text/plain"},"text/html":{"content":"<div>\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\"> </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px;\">Client</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Client-742330ff-7715-11f0-90ff-002248207cfa</p>\n        <table style=\"width: 100%; text-align: left;\">\n\n        <tr>\n        \n            <td style=\"text-align: left;\"><strong>Connection method:</strong> Cluster object</td>\n            <td style=\"text-align: left;\"><strong>Cluster type:</strong> distributed.LocalCluster</td>\n        \n        </tr>\n\n        \n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:37315/status\" target=\"_blank\">http://127.0.0.1:37315/status</a>\n                </td>\n                <td style=\"text-align: left;\"></td>\n            </tr>\n        \n\n        </table>\n\n        \n            <button style=\"margin-bottom: 12px;\" data-commandlinker-command=\"dask:populate-and-launch-layout\" data-commandlinker-args='{\"url\": \"http://127.0.0.1:37315/status\" }'>\n                Launch dashboard in JupyterLab\n            </button>\n        \n\n        \n            <details>\n            <summary style=\"margin-bottom: 20px;\"><h3 style=\"display: inline;\">Cluster Info</h3></summary>\n            <div class=\"jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output\">\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\">\n    </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px; margin-top: 0px;\">LocalCluster</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">c0f1148b</p>\n        <table style=\"width: 100%; text-align: left;\">\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:37315/status\" target=\"_blank\">http://127.0.0.1:37315/status</a>\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Workers:</strong> 8\n                </td>\n            </tr>\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Total threads:</strong> 8\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Total memory:</strong> 15.62 GiB\n                </td>\n            </tr>\n            \n            <tr>\n    <td style=\"text-align: left;\"><strong>Status:</strong> running</td>\n    <td style=\"text-align: left;\"><strong>Using processes:</strong> True</td>\n</tr>\n\n            \n        </table>\n\n        <details>\n            <summary style=\"margin-bottom: 20px;\">\n                <h3 style=\"display: inline;\">Scheduler Info</h3>\n            </summary>\n\n            <div style=\"\">\n    <div>\n        <div style=\"width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;\"> </div>\n        <div style=\"margin-left: 48px;\">\n            <h3 style=\"margin-bottom: 0px;\">Scheduler</h3>\n            <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Scheduler-64a792ae-f016-412a-9e11-7a24611d4b4f</p>\n            <table style=\"width: 100%; text-align: left;\">\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Comm:</strong> tcp://127.0.0.1:39075\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Workers:</strong> 0 \n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:37315/status\" target=\"_blank\">http://127.0.0.1:37315/status</a>\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total threads:</strong> 0\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Started:</strong> Just now\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total memory:</strong> 0 B\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n\n    <details style=\"margin-left: 48px;\">\n        <summary style=\"margin-bottom: 20px;\">\n            <h3 style=\"display: inline;\">Workers</h3>\n        </summary>\n\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 0</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:40593\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:39643/status\" target=\"_blank\">http://127.0.0.1:39643/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:32811\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-kb1cxw61\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 1</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:41749\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:38207/status\" target=\"_blank\">http://127.0.0.1:38207/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:41987\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-1jzqe952\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 2</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:35955\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:35415/status\" target=\"_blank\">http://127.0.0.1:35415/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:41295\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-3tpxuek9\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 3</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:32999\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:32795/status\" target=\"_blank\">http://127.0.0.1:32795/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:40213\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-wmbbi2rg\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 4</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:42777\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:37545/status\" target=\"_blank\">http://127.0.0.1:37545/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:43987\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-9k2p06hg\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 5</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:43273\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:40353/status\" target=\"_blank\">http://127.0.0.1:40353/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:43073\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-33z_ontj\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 6</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:33149\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:46443/status\" target=\"_blank\">http://127.0.0.1:46443/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:34725\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-u44wkwpw\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 7</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:34317\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:43617/status\" target=\"_blank\">http://127.0.0.1:43617/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:39817\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-xfm5h129\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n\n    </details>\n</div>\n\n        </details>\n    </div>\n</div>\n            </details>\n        \n\n    </div>\n</div>","content_type":"text/html"}}}],"key":"laxA92GaoC"}],"key":"jzkxoMLZvI"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Iterate through list of files and create ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dIkZtJ5z0X"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NUgAlJfazu"},{"type":"text","value":" indices as ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ApRzSOZWPd"},{"type":"inlineCode","value":".json","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"X9Fik3Uky5"},{"type":"text","value":" reference files","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ntsmkBUCNA"}],"identifier":"iterate-through-list-of-files-and-create-kerchunk-indices-as-json-reference-files","label":"Iterate through list of files and create Kerchunk indices as .json reference files","html_id":"iterate-through-list-of-files-and-create-kerchunk-indices-as-json-reference-files","implicit":true,"key":"jla61IVRoy"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Each input GRIB2 file contains multiple “messages”, each a measure of some variable on a grid, but with grid dimensions not necessarily compatible with one-another. The filter we create in the first line selects only certain types of messages, and indicated that heightAboveGround will be a coordinate of interest.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qJuwnUgsEt"}],"key":"C1K9v5IgHD"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"We also write a separate JSON for each of the selected message, since these are the basic component data sets (see the loop over ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GkFOB7TGs2"},{"type":"inlineCode","value":"out","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"hZvDoqCue3"},{"type":"text","value":").","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"EgVr5U9CXc"}],"key":"tjSE9uLqLQ"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Note","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"eHZE6bsoEP"}],"key":"Ryz40Rslsh"},{"type":"text","value":": ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"SaXmwxuQY6"},{"type":"inlineCode","value":"scan_grib","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"XqRWgpThfa"},{"type":"text","value":" does not require a filter and will happily create a reference file for each available grib message. However when combining the grib messages using ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"KZex6upVbp"},{"type":"inlineCode","value":"MultiZarrToZarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Zwjlenn19Z"},{"type":"text","value":" it is necessary for the messages to share a coordinate system. Thus to make our lives easier and ensure all reference outputs from ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"RNWY8mTdFb"},{"type":"inlineCode","value":"scan_grib","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jDRydppoEC"},{"type":"text","value":" share a coordinate system we pass a filter argument.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"N7PHg9tu1H"}],"key":"iyVvlFtaww"}],"key":"c1BpXLuZcs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"afilter = {\"typeOfLevel\": \"heightAboveGround\", \"level\": [2, 10]}\nso = {\"anon\": True}\n\n# We are creating a temporary directory to store the .json reference files\n# Alternately, you could write these to cloud storage.\ntd = TemporaryDirectory()\ntemp_dir = td.name\ntemp_dir","key":"gudseLJhd8"},{"type":"output","id":"Kw5hgraFe1VxDNtNMDUI1","data":[{"output_type":"execute_result","execution_count":5,"metadata":{},"data":{"text/plain":{"content":"'/tmp/tmp3iyx_8pz'","content_type":"text/plain"}}}],"key":"V6hUgPprHK"}],"key":"k3aV7xOV4F"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def make_json_name(\n    file_url, message_number\n):  # create a unique name for each reference file\n    date = file_url.split(\"/\")[3].split(\".\")[1]\n    name = file_url.split(\"/\")[5].split(\".\")[1:3]\n    return f\"{temp_dir}/{date}_{name[0]}_{name[1]}_message{message_number}.json\"\n\n\ndef gen_json(file_url):\n    out = scan_grib(\n        file_url, storage_options=so, inline_threshold=100, filter=afilter\n    )  # create the reference using scan_grib\n    for i, message in enumerate(\n        out\n    ):  # scan_grib outputs a list containing one reference per grib message\n        out_file_name = make_json_name(file_url, i)  # get name\n        with open(out_file_name, \"w\") as f:\n            f.write(ujson.dumps(message))  # write to file\n\n\n# Generate Dask Delayed objects\ntasks = [dask.delayed(gen_json)(fil) for fil in files]","key":"CLJ167oO3D"},{"type":"output","id":"ZJzZaP7LkIGsddZTItaOP","data":[],"key":"V3NoeMDxeG"}],"key":"DlZ2ZGMHUT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Start parallel processing\nimport warnings\n\nwarnings.filterwarnings(\"ignore\")\ndask.compute(tasks)","key":"ZWXgl4oWwo"},{"type":"output","id":"Pp_mA7k7dzxfxOJWIs2C5","data":[{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/plain":{"content":"([None, None],)","content_type":"text/plain"}}}],"key":"NlTEdQcByS"}],"key":"faUA3cTVJt"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combine ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uVDoolo6sM"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xlmISl6CPu"},{"type":"text","value":" reference ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RXztHSvgR4"},{"type":"inlineCode","value":".json","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cIeawCS7mo"},{"type":"text","value":" files","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LEYHCRLUTI"}],"identifier":"combine-kerchunk-reference-json-files","label":"Combine Kerchunk reference .json files","html_id":"combine-kerchunk-reference-json-files","implicit":true,"key":"fmuDiNCHJ9"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We know that four coordinates are identical for every one of our component datasets - they are not functions of valid_time.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"AvEj8RIyhJ"}],"key":"Ud52gUOKMB"}],"key":"jS7WoCrAdA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Create a list of reference json files\noutput_files = glob.glob(f\"{temp_dir}/*.json\")\n\n# Combine individual references into single consolidated reference\nmzz = MultiZarrToZarr(\n    output_files,\n    concat_dims=[\"valid_time\"],\n    identical_dims=[\"latitude\", \"longitude\", \"heightAboveGround\", \"step\"],\n)\nmulti_kerchunk = mzz.translate()","key":"DuC0ytJnEj"},{"type":"output","id":"eX1qV7owHGiQGgXe7IhQc","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mRuntimeError\u001b[39m                              Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[8]\u001b[39m\u001b[32m, line 10\u001b[39m\n\u001b[32m      4\u001b[39m \u001b[38;5;66;03m# Combine individual references into single consolidated reference\u001b[39;00m\n\u001b[32m      5\u001b[39m mzz = MultiZarrToZarr(\n\u001b[32m      6\u001b[39m     output_files,\n\u001b[32m      7\u001b[39m     concat_dims=[\u001b[33m\"\u001b[39m\u001b[33mvalid_time\u001b[39m\u001b[33m\"\u001b[39m],\n\u001b[32m      8\u001b[39m     identical_dims=[\u001b[33m\"\u001b[39m\u001b[33mlatitude\u001b[39m\u001b[33m\"\u001b[39m, \u001b[33m\"\u001b[39m\u001b[33mlongitude\u001b[39m\u001b[33m\"\u001b[39m, \u001b[33m\"\u001b[39m\u001b[33mheightAboveGround\u001b[39m\u001b[33m\"\u001b[39m, \u001b[33m\"\u001b[39m\u001b[33mstep\u001b[39m\u001b[33m\"\u001b[39m],\n\u001b[32m      9\u001b[39m )\n\u001b[32m---> \u001b[39m\u001b[32m10\u001b[39m multi_kerchunk = \u001b[43mmzz\u001b[49m\u001b[43m.\u001b[49m\u001b[43mtranslate\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/kerchunk/combine.py:647\u001b[39m, in \u001b[36mMultiZarrToZarr.translate\u001b[39m\u001b[34m(self, filename, storage_options)\u001b[39m\n\u001b[32m    645\u001b[39m     \u001b[38;5;28mself\u001b[39m.first_pass()\n\u001b[32m    646\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[32m2\u001b[39m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mself\u001b[39m.done:\n\u001b[32m--> \u001b[39m\u001b[32m647\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mstore_coords\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    648\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[32m3\u001b[39m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mself\u001b[39m.done:\n\u001b[32m    649\u001b[39m     \u001b[38;5;28mself\u001b[39m.second_pass()\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/kerchunk/combine.py:473\u001b[39m, in \u001b[36mMultiZarrToZarr.store_coords\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    470\u001b[39m \u001b[38;5;28mself\u001b[39m.out.update(kv)\n\u001b[32m    471\u001b[39m logger.debug(\u001b[33m\"\u001b[39m\u001b[33mWritten coordinates\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m--> \u001b[39m\u001b[32m473\u001b[39m metadata = \u001b[43masyncio\u001b[49m\u001b[43m.\u001b[49m\u001b[43mrun\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_read_meta_files\u001b[49m\u001b[43m(\u001b[49m\u001b[43mm\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43m.zgroup\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43m.zattrs\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m)\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    474\u001b[39m \u001b[38;5;28mself\u001b[39m.out.update(metadata)\n\u001b[32m    475\u001b[39m logger.debug(\u001b[33m\"\u001b[39m\u001b[33mWritten global metadata\u001b[39m\u001b[33m\"\u001b[39m)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/asyncio/runners.py:191\u001b[39m, in \u001b[36mrun\u001b[39m\u001b[34m(main, debug, loop_factory)\u001b[39m\n\u001b[32m    161\u001b[39m \u001b[38;5;250m\u001b[39m\u001b[33;03m\"\"\"Execute the coroutine and return the result.\u001b[39;00m\n\u001b[32m    162\u001b[39m \n\u001b[32m    163\u001b[39m \u001b[33;03mThis function runs the passed coroutine, taking care of\u001b[39;00m\n\u001b[32m   (...)\u001b[39m\u001b[32m    187\u001b[39m \u001b[33;03m    asyncio.run(main())\u001b[39;00m\n\u001b[32m    188\u001b[39m \u001b[33;03m\"\"\"\u001b[39;00m\n\u001b[32m    189\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m events._get_running_loop() \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m    190\u001b[39m     \u001b[38;5;66;03m# fail fast with short traceback\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m191\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mRuntimeError\u001b[39;00m(\n\u001b[32m    192\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33masyncio.run() cannot be called from a running event loop\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m    194\u001b[39m \u001b[38;5;28;01mwith\u001b[39;00m Runner(debug=debug, loop_factory=loop_factory) \u001b[38;5;28;01mas\u001b[39;00m runner:\n\u001b[32m    195\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m runner.run(main)\n\n\u001b[31mRuntimeError\u001b[39m: asyncio.run() cannot be called from a running event loop","ename":"RuntimeError","evalue":"asyncio.run() cannot be called from a running event loop"}],"key":"po0cONakMi"}],"key":"TiffKVHhBs"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Write combined ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YghDP4GEiY"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"P3HoyBIml7"},{"type":"text","value":" reference file to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QVMIJYwFNk"},{"type":"inlineCode","value":".json","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vUEFQ2IhoN"}],"identifier":"write-combined-kerchunk-reference-file-to-json","label":"Write combined Kerchunk reference file to .json","html_id":"write-combined-kerchunk-reference-file-to-json","implicit":true,"key":"rSei9pI7g0"}],"key":"PRMbqFqAGg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Write Kerchunk .json record\noutput_fname = \"HRRR_combined.json\"\nwith open(f\"{output_fname}\", \"wb\") as f:\n    f.write(ujson.dumps(multi_kerchunk).encode())","key":"FIoSXRfPwu"},{"type":"output","id":"-1Fu_FzTfjYZqKZbI-Myd","data":[],"key":"MgD2pHhrPH"}],"key":"Xt9rfynKiO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Shut down the Dask cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"J3Jesl8Doe"}],"identifier":"shut-down-the-dask-cluster","label":"Shut down the Dask cluster","html_id":"shut-down-the-dask-cluster","implicit":true,"key":"FyR8sI7Jfx"}],"key":"zFXrUAh1CZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.shutdown()","key":"r6dvazaj5P"},{"type":"output","id":"GjDgw4U5p5iY0_k-bzWhi","data":[],"key":"MBVmRoWeuO"}],"key":"N1kjBJoOcL"}],"key":"I7ueNAH6mW"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"NetCDF","url":"/notebooks/generating-references/netcdf","group":"Generating Reference Files"},"next":{"title":"GeoTIFF","url":"/notebooks/generating-references/geotiff","group":"Generating Reference Files"}}},"domain":"http://localhost:3000"}
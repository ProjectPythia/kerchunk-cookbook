{"version":2,"kind":"Notebook","sha256":"701b929d406092b26b4ca3623dbf34b5b751bfa46fd8be85eb54aa9e00735184","slug":"notebooks.foundations.kerchunk-multi-file","location":"/notebooks/foundations/02_kerchunk_multi_file.ipynb","dependencies":[],"frontmatter":{"title":"Multi-file virtual datasets with VirtualiZarr","content_includes_title":true,"kernelspec":{"name":"python3","display_name":"kerchunk-cookbook","language":"python"},"authors":[{"nameParsed":{"literal":"Norland Raphael Hagen","given":"Norland Raphael","family":"Hagen"},"name":"Norland Raphael Hagen","id":"contributors-myst-generated-uid-0"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/kerchunk-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/kerchunk-cookbook/blob/main/notebooks/foundations/02_kerchunk_multi_file.ipynb","thumbnail":"/kerchunk-cookbook/build/thumbnail-e94c0ff712cdef5f24ce46dac0f879cc.png","exports":[{"format":"ipynb","filename":"02_kerchunk_multi_file.ipynb","url":"/kerchunk-cookbook/build/02_kerchunk_multi_fi-f1b2501405fccadaf763a7c760f81923.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"image","url":"/kerchunk-cookbook/build/thumbnail-e94c0ff712cdef5f24ce46dac0f879cc.png","alt":"Kerchunk Logo","width":500,"key":"xpqztKbg6F","urlSource":"../../thumbnail.png"}],"key":"f3kPNy5I2O"}],"key":"RiC0xtNPsi"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":1,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Multi-file virtual datasets with VirtualiZarr","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MEsO8zNYwp"}],"identifier":"multi-file-virtual-datasets-with-virtualizarr","label":"Multi-file virtual datasets with VirtualiZarr","html_id":"multi-file-virtual-datasets-with-virtualizarr","implicit":true,"key":"UkgPBuhOHy"}],"key":"R08bnKprUH"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PYSJL5klSd"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"QDo0t8a8mB"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook is intends to build off of the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QES1AK6JWh"},{"type":"link","url":"/notebooks/foundations/kerchunk-basics","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Basics of virtual Zarr stores","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BcCEGoWuBL"}],"urlSource":"./01_kerchunk_basics.ipynb","dataUrl":"/notebooks.foundations.kerchunk-basics.json","internal":true,"protocol":"file","key":"hzNJGwfTka"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bv2AXkaY4A"}],"key":"BezRYSbLR3"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"In this tutorial we will:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"iK5XVPws4s"}],"key":"aWoJml2Nhl"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Create a list of input paths for a collection of NetCDF files stored on the cloud.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"DDmqMYqce5"}],"key":"mOlBzwJpm4"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Create virtual datasets for each input datasets","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"pZlSxMqq85"}],"key":"RF3MJ37H0c"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Combine the virtual datasets using combine_nested","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"qpPvNKgR6t"}],"key":"VUYWya3L6Q"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Read the combined dataset using ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"NPedRumWsi"},{"type":"link","url":"https://docs.xarray.dev/en/stable/","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"inlineCode","value":"Xarray","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"uaIviEoN0N"}],"urlSource":"https://docs.xarray.dev/en/stable/","key":"qUwxFgOafJ"},{"type":"text","value":" and ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"BChh0MXkEX"},{"type":"link","url":"https://filesystem-spec.readthedocs.io/en/latest/","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"inlineCode","value":"fsspec","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"rsuIbF13kD"}],"urlSource":"https://filesystem-spec.readthedocs.io/en/latest/","key":"aWStz3eMMw"},{"type":"text","value":".","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"zkzQ1BC0CH"}],"key":"cPN1BOLJdB"}],"key":"Sv8lbYpEuc"}],"key":"KHfsg4nd5u"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GsJKHy8N6m"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"yxtr6hM36U"},{"type":"table","position":{"start":{"line":2,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"vCwdZGibs0"}],"key":"PUhrfuuzKo"},{"type":"tableCell","header":true,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"WcBOL3WahG"}],"key":"jVs7xRt4OW"},{"type":"tableCell","header":true,"position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"RvMshVaUQB"}],"key":"wAIj70VjXe"}],"key":"EhjfjUHKFt"},{"type":"tableRow","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"link","url":"/notebooks/foundations/kerchunk-basics","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Basics of virtual Zarr stores","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"UDOhm6ir8V"}],"urlSource":"./01_kerchunk_basics.ipynb","dataUrl":"/notebooks.foundations.kerchunk-basics.json","internal":true,"protocol":"file","key":"PkjxQqtBp4"}],"key":"cMBrcJre9C"},{"type":"tableCell","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Po2MQpLMCc"}],"key":"BlRluVYW4B"},{"type":"tableCell","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Basic features","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"DoWAgSla5s"}],"key":"wJTgmaKFjD"}],"key":"Iu70V3lpee"},{"type":"tableRow","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray/xarray-intro.html","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Introduction to Xarray","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"WgjdK3z9q3"}],"urlSource":"https://foundations.projectpythia.org/core/xarray/xarray-intro.html","key":"Xe1GtNmA0i"}],"key":"LvFyXk6aOB"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Recommended","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"UJlHOLnq47"}],"key":"I3DlTOWo9P"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"IO","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"OvGH5cZGEL"}],"key":"gcRP7Hv8ZB"}],"key":"RU4RRBTiQK"}],"key":"M3UlzIevF0"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"strong","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"gQTVQMAvaP"}],"key":"DfeZDrFfrZ"},{"type":"text","value":": 60 minutes","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ERt9VyWkyN"}],"key":"l9pI3AT2lk"}],"key":"tZ5eCSEGPo"},{"type":"thematicBreak","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"uPOZ6OAjum"}],"key":"XW6trktuCC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Flags","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vpAAlPXoqZ"}],"identifier":"flags","label":"Flags","html_id":"flags","implicit":true,"key":"WqqkmcPJcC"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In the section below, set the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"NzVGiquWXW"},{"type":"inlineCode","value":"subset","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"WH1OKmTK2P"},{"type":"text","value":" flag to be ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"WG32HhrAdW"},{"type":"inlineCode","value":"True","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"boMeXRBdSe"},{"type":"text","value":" (default) or ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"iWIx5p8HOY"},{"type":"inlineCode","value":"False","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"bzQZqY9Mh3"},{"type":"text","value":" depending if you want this notebook to process the full file list. If set to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"b3Y7XlBnSf"},{"type":"inlineCode","value":"True","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"hCRz6zdhBn"},{"type":"text","value":", then a subset of the file list will be processed (Recommended)","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"trdl8N9cyO"}],"key":"JuRDrts4gK"}],"key":"gajlrELqL6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"subset_flag = True","key":"vbPTeJyc5w"},{"type":"output","id":"9GBc1Jq8SfoOj4tUQda2S","data":[],"key":"hVy9pDhB51"}],"key":"gKgp8HR9Hr"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OIvrx3weI9"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"V7uuGs6NPi"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In our imports block we are using similar imports to the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"aBaRoIWvqI"},{"type":"link","url":"/notebooks/foundations/kerchunk-basics","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Basics of virtual Zarr stores tutorial","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"OKZaxAUcAS"}],"urlSource":"./01_kerchunk_basics.ipynb","dataUrl":"/notebooks.foundations.kerchunk-basics.json","internal":true,"protocol":"file","key":"Y8cUdeEKiy"},{"type":"text","value":":","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"gIpfSEbwSF"}],"key":"FjeO37HJBn"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"fsspec","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WS5MaI6mKN"},{"type":"text","value":" for reading and writing to remote file systems","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"msfAm1j4Dm"}],"key":"yQKKTtslgc"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"inlineCode","value":"virtualizarr","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"PazJqJhLha"},{"type":"text","value":" will be used to generate the virtual Zarr store","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"gD8M328QdJ"}],"key":"tCDA1Ntjvt"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"inlineCode","value":"Xarray","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"asXUssk8jC"},{"type":"text","value":" for examining the output dataset","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"fL1kWlBKLc"}],"key":"q6vsHo74rf"}],"key":"nel8P98ahD"}],"key":"PhJjZ7xdVX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import fsspec\nimport xarray as xr\nfrom virtualizarr import open_virtual_dataset","key":"DucgEBb3PI"},{"type":"output","id":"M3hVhyKV1lqZQYgmvfoh3","data":[],"key":"V2mAxHABYS"}],"key":"Clk2I5gZDL"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create a File Pattern from a list of  input NetCDF files","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NFxG7Ho892"}],"identifier":"create-a-file-pattern-from-a-list-of-input-netcdf-files","label":"Create a File Pattern from a list of  input NetCDF files","html_id":"create-a-file-pattern-from-a-list-of-input-netcdf-files","implicit":true,"key":"zMmB4w6NyB"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Below we will create a list of input files we want to virtualize. In the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xIhLxhnlB3"},{"type":"link","url":"/notebooks/foundations/kerchunk-basics","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Basics of virtual Zarr stores tutorial","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qfqwjCxTN0"}],"urlSource":"./01_kerchunk_basics.ipynb","dataUrl":"/notebooks.foundations.kerchunk-basics.json","internal":true,"protocol":"file","key":"YXVjYH7AtC"},{"type":"text","value":", we looked at a single file of climate downscaled data over Southern Alaska. In this example, we will build off of that work and use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"RHcQTcQUc1"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"baV5dGEAoe"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XhTk1jxXD6"},{"type":"inlineCode","value":"VirtualiZarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bd98M8bE5m"},{"type":"text","value":" to combine multiple NetCDF files of this dataset into a virtual dataset that can be read as if it were a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"g0tSkNe23w"},{"type":"inlineCode","value":"Zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FvG4zrBISk"},{"type":"text","value":" store - without copying any data.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"RX0yxmgi7b"}],"key":"n1wXge0rCa"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"We use the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"HfaBTUlhvS"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"eKGqYhvwGX"},{"type":"text","value":" ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rp9WCHSLbs"},{"type":"inlineCode","value":"s3","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"pkcgukjkK4"},{"type":"text","value":" filesystem’s ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QomvX1ny9c"},{"type":"emphasis","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"glob","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Q5sz1XMW41"}],"key":"v1BwELNAk1"},{"type":"text","value":" method to create a list of files matching a file pattern. We supply the base url of ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"iLANfPucQh"},{"type":"inlineCode","value":"s3://wrf-se-ak-ar5/ccsm/rcp85/daily/2060/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GOw1rWkP1h"},{"type":"text","value":", which is pointing to an ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"HCCiGxF48d"},{"type":"inlineCode","value":"AWS","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"hei4BFpmUi"},{"type":"text","value":" public bucket, for daily rcp85 ccsm downscaled data for the year 2060. After this base url, we tacked on ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"BIYLcW9UZC"},{"type":"emphasis","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"inlineCode","value":"*","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"UhTOQAzzoz"}],"key":"If41Vppm4s"},{"type":"text","value":", which acts as a wildcard for all the files in the directory. We should expect 365 daily ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ux5wqUbMiD"},{"type":"inlineCode","value":"NetCDF","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"g04hS9Azmj"},{"type":"text","value":" files.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Wikn1Ms1LZ"}],"key":"AXl2ywZksS"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Finally, we are appending the string ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"zgMRuJtHsW"},{"type":"inlineCode","value":"s3://","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"FPbSeXYNzN"},{"type":"text","value":" to the list of return files. This will ensure the list of files we get back are ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"TumLv30wln"},{"type":"inlineCode","value":"s3","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"rftGy697BU"},{"type":"text","value":" urls and can be read by ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"yyz3zvqCAS"},{"type":"inlineCode","value":"VirtualiZarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"wEHIASY1CL"},{"type":"text","value":" and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"vqE7T3vsIi"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"npdfdFAPVQ"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"akPJMu9Wk6"}],"key":"gTLpn6By4C"}],"key":"p0vbkYNAfL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Initiate fsspec filesystems for reading and writing\nfs_read = fsspec.filesystem(\"s3\", anon=True, skip_instance_cache=True)\n\n# Retrieve list of available days in archive for the year 2060.\nfiles_paths = fs_read.glob(\"s3://wrf-se-ak-ar5/ccsm/rcp85/daily/2060/*\")\n\n# Here we prepend the prefix 's3://', which points to AWS.\nfiles_paths = sorted([\"s3://\" + f for f in files_paths])","key":"Hrnfd80jda"},{"type":"output","id":"0a11dwOSWqTejdI_pOM1f","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mAttributeError\u001b[39m                            Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[3]\u001b[39m\u001b[32m, line 5\u001b[39m\n\u001b[32m      2\u001b[39m fs_read = fsspec.filesystem(\u001b[33m\"\u001b[39m\u001b[33ms3\u001b[39m\u001b[33m\"\u001b[39m, anon=\u001b[38;5;28;01mTrue\u001b[39;00m, skip_instance_cache=\u001b[38;5;28;01mTrue\u001b[39;00m)\n\u001b[32m      4\u001b[39m \u001b[38;5;66;03m# Retrieve list of available days in archive for the year 2060.\u001b[39;00m\n\u001b[32m----> \u001b[39m\u001b[32m5\u001b[39m files_paths = \u001b[43mfs_read\u001b[49m\u001b[43m.\u001b[49m\u001b[43mglob\u001b[49m\u001b[43m(\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43ms3://wrf-se-ak-ar5/ccsm/rcp85/daily/2060/*\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m)\u001b[49m\n\u001b[32m      7\u001b[39m \u001b[38;5;66;03m# Here we prepend the prefix 's3://', which points to AWS.\u001b[39;00m\n\u001b[32m      8\u001b[39m files_paths = \u001b[38;5;28msorted\u001b[39m([\u001b[33m\"\u001b[39m\u001b[33ms3://\u001b[39m\u001b[33m\"\u001b[39m + f \u001b[38;5;28;01mfor\u001b[39;00m f \u001b[38;5;129;01min\u001b[39;00m files_paths])\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:118\u001b[39m, in \u001b[36msync_wrapper.<locals>.wrapper\u001b[39m\u001b[34m(*args, **kwargs)\u001b[39m\n\u001b[32m    115\u001b[39m \u001b[38;5;129m@functools\u001b[39m.wraps(func)\n\u001b[32m    116\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mwrapper\u001b[39m(*args, **kwargs):\n\u001b[32m    117\u001b[39m     \u001b[38;5;28mself\u001b[39m = obj \u001b[38;5;129;01mor\u001b[39;00m args[\u001b[32m0\u001b[39m]\n\u001b[32m--> \u001b[39m\u001b[32m118\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43msync\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mloop\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mfunc\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43margs\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:103\u001b[39m, in \u001b[36msync\u001b[39m\u001b[34m(loop, func, timeout, *args, **kwargs)\u001b[39m\n\u001b[32m    101\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m FSTimeoutError \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mreturn_result\u001b[39;00m\n\u001b[32m    102\u001b[39m \u001b[38;5;28;01melif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(return_result, \u001b[38;5;167;01mBaseException\u001b[39;00m):\n\u001b[32m--> \u001b[39m\u001b[32m103\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m return_result\n\u001b[32m    104\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m    105\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m return_result\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:56\u001b[39m, in \u001b[36m_runner\u001b[39m\u001b[34m(event, coro, result, timeout)\u001b[39m\n\u001b[32m     54\u001b[39m     coro = asyncio.wait_for(coro, timeout=timeout)\n\u001b[32m     55\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m---> \u001b[39m\u001b[32m56\u001b[39m     result[\u001b[32m0\u001b[39m] = \u001b[38;5;28;01mawait\u001b[39;00m coro\n\u001b[32m     57\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mException\u001b[39;00m \u001b[38;5;28;01mas\u001b[39;00m ex:\n\u001b[32m     58\u001b[39m     result[\u001b[32m0\u001b[39m] = ex\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:807\u001b[39m, in \u001b[36mAsyncFileSystem._glob\u001b[39m\u001b[34m(self, path, maxdepth, **kwargs)\u001b[39m\n\u001b[32m    804\u001b[39m     \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m    805\u001b[39m         depth = \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m807\u001b[39m allpaths = \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._find(\n\u001b[32m    808\u001b[39m     root, maxdepth=depth, withdirs=\u001b[38;5;28;01mTrue\u001b[39;00m, detail=\u001b[38;5;28;01mTrue\u001b[39;00m, **kwargs\n\u001b[32m    809\u001b[39m )\n\u001b[32m    811\u001b[39m pattern = glob_translate(path + (\u001b[33m\"\u001b[39m\u001b[33m/\u001b[39m\u001b[33m\"\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m ends_with_sep \u001b[38;5;28;01melse\u001b[39;00m \u001b[33m\"\u001b[39m\u001b[33m\"\u001b[39m))\n\u001b[32m    812\u001b[39m pattern = re.compile(pattern)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/s3fs/core.py:558\u001b[39m, in \u001b[36mS3FileSystem._find\u001b[39m\u001b[34m(self, path, maxdepth, withdirs, detail)\u001b[39m\n\u001b[32m    556\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\u001b[33m\"\u001b[39m\u001b[33mCannot traverse all of S3\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m    557\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m maxdepth:\n\u001b[32m--> \u001b[39m\u001b[32m558\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28msuper\u001b[39m()._find(\n\u001b[32m    559\u001b[39m         bucket + \u001b[33m\"\u001b[39m\u001b[33m/\u001b[39m\u001b[33m\"\u001b[39m + key, maxdepth=maxdepth, withdirs=withdirs, detail=detail\n\u001b[32m    560\u001b[39m     )\n\u001b[32m    561\u001b[39m \u001b[38;5;66;03m# TODO: implement find from dircache, if all listings are present\u001b[39;00m\n\u001b[32m    562\u001b[39m \u001b[38;5;66;03m# if refresh is False:\u001b[39;00m\n\u001b[32m    563\u001b[39m \u001b[38;5;66;03m#     out = incomplete_tree_dirs(self.dircache, path)\u001b[39;00m\n\u001b[32m   (...)\u001b[39m\u001b[32m    568\u001b[39m \u001b[38;5;66;03m#         return super().find(path)\u001b[39;00m\n\u001b[32m    569\u001b[39m \u001b[38;5;66;03m#     # else: we refresh anyway, having at least two missing trees\u001b[39;00m\n\u001b[32m    570\u001b[39m out = \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._lsdir(path, delimiter=\u001b[33m\"\u001b[39m\u001b[33m\"\u001b[39m)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/fsspec/asyn.py:847\u001b[39m, in \u001b[36mAsyncFileSystem._find\u001b[39m\u001b[34m(self, path, maxdepth, withdirs, **kwargs)\u001b[39m\n\u001b[32m    843\u001b[39m detail = kwargs.pop(\u001b[33m\"\u001b[39m\u001b[33mdetail\u001b[39m\u001b[33m\"\u001b[39m, \u001b[38;5;28;01mFalse\u001b[39;00m)\n\u001b[32m    845\u001b[39m \u001b[38;5;66;03m# Add the root directory if withdirs is requested\u001b[39;00m\n\u001b[32m    846\u001b[39m \u001b[38;5;66;03m# This is needed for posix glob compliance\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m847\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m withdirs \u001b[38;5;129;01mand\u001b[39;00m path != \u001b[33m\"\u001b[39m\u001b[33m\"\u001b[39m \u001b[38;5;129;01mand\u001b[39;00m \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._isdir(path):\n\u001b[32m    848\u001b[39m     out[path] = \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._info(path)\n\u001b[32m    850\u001b[39m \u001b[38;5;66;03m# async for?\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/s3fs/core.py:1021\u001b[39m, in \u001b[36mS3FileSystem._isdir\u001b[39m\u001b[34m(self, path)\u001b[39m\n\u001b[32m   1018\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;01mFalse\u001b[39;00m\n\u001b[32m   1020\u001b[39m \u001b[38;5;66;03m# This only returns things within the path and NOT the path object itself\u001b[39;00m\n\u001b[32m-> \u001b[39m\u001b[32m1021\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28mbool\u001b[39m(\u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._lsdir(path))\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/s3fs/core.py:509\u001b[39m, in \u001b[36mS3FileSystem._lsdir\u001b[39m\u001b[34m(self, path, refresh, max_items, delimiter)\u001b[39m\n\u001b[32m    507\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m    508\u001b[39m     logger.debug(\u001b[33m\"\u001b[39m\u001b[33mGet directory listing page for \u001b[39m\u001b[38;5;132;01m%s\u001b[39;00m\u001b[33m\"\u001b[39m % path)\n\u001b[32m--> \u001b[39m\u001b[32m509\u001b[39m     \u001b[38;5;28;01mawait\u001b[39;00m \u001b[38;5;28mself\u001b[39m._connect()\n\u001b[32m    510\u001b[39m     pag = \u001b[38;5;28mself\u001b[39m.s3.get_paginator(\u001b[33m\"\u001b[39m\u001b[33mlist_objects_v2\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m    511\u001b[39m     config = {}\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/s3fs/core.py:365\u001b[39m, in \u001b[36mS3FileSystem._connect\u001b[39m\u001b[34m(self, refresh, kwargs)\u001b[39m\n\u001b[32m    363\u001b[39m     config_kwargs[\u001b[33m\"\u001b[39m\u001b[33msignature_version\u001b[39m\u001b[33m\"\u001b[39m] = UNSIGNED\n\u001b[32m    364\u001b[39m conf = AioConfig(**config_kwargs)\n\u001b[32m--> \u001b[39m\u001b[32m365\u001b[39m \u001b[38;5;28mself\u001b[39m.session = \u001b[43maiobotocore\u001b[49m\u001b[43m.\u001b[49m\u001b[43mAioSession\u001b[49m(**\u001b[38;5;28mself\u001b[39m.kwargs)\n\u001b[32m    366\u001b[39m s3creator = \u001b[38;5;28mself\u001b[39m.session.create_client(\n\u001b[32m    367\u001b[39m     \u001b[33m\"\u001b[39m\u001b[33ms3\u001b[39m\u001b[33m\"\u001b[39m, config=conf, **init_kwargs, **client_kwargs\n\u001b[32m    368\u001b[39m )\n\u001b[32m    369\u001b[39m \u001b[38;5;28mself\u001b[39m._s3creator = s3creator\n\n\u001b[31mAttributeError\u001b[39m: module 'aiobotocore' has no attribute 'AioSession'","ename":"AttributeError","evalue":"module 'aiobotocore' has no attribute 'AioSession'"}],"key":"mbg928ocgp"}],"key":"lyxZBagqs5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"As a quick check, it looks like we have a list 365 file paths, which should be a year of downscaled climte data.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"e7p3dbNEbR"}],"identifier":"as-a-quick-check-it-looks-like-we-have-a-list-365-file-paths-which-should-be-a-year-of-downscaled-climte-data","label":"As a quick check, it looks like we have a list 365 file paths, which should be a year of downscaled climte data.","html_id":"as-a-quick-check-it-looks-like-we-have-a-list-365-file-paths-which-should-be-a-year-of-downscaled-climte-data","implicit":true,"key":"Zfru4zhVdA"}],"key":"TqJUalB1uZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print(f\"{len(files_paths)} file paths were retrieved.\")","key":"u8QzjtRTjK"},{"type":"output","id":"z7eTELOKE9yRuSFvChvMb","data":[],"key":"z9WUSQnHja"}],"key":"hG8X3184IM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# If the subset_flag == True (default), the list of input files will\n# be subset to speed up the processing\nif subset_flag:\n    files_paths = files_paths[0:4]","key":"PmuEoJRS29"},{"type":"output","id":"rUKWaM2epZjEiBcTx4RdQ","data":[],"key":"b2AdKiEBCb"}],"key":"eCV31kafQe"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Optional: If you want to examine one NetCDF files before creating the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pDQjbacGeP"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ru6pphZ8C3"},{"type":"text","value":" index, try uncommenting this code snippet below.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QO1k36GECm"}],"identifier":"optional-if-you-want-to-examine-one-netcdf-files-before-creating-the-kerchunk-index-try-uncommenting-this-code-snippet-below","label":"Optional: If you want to examine one NetCDF files before creating the Kerchunk index, try uncommenting this code snippet below.","html_id":"optional-if-you-want-to-examine-one-netcdf-files-before-creating-the-kerchunk-index-try-uncommenting-this-code-snippet-below","implicit":true,"key":"x3d19QCHXw"}],"key":"X0IlfdO3E8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"## Note: Optional piece of code to view one of the NetCDFs\n\n# import s3fs\n\n# fs = fsspec.filesystem(\"s3\",anon=True)\n# ds = xr.open_dataset(fs.open(file_pattern[0]))","key":"UJjOHRjq6E"},{"type":"output","id":"3QEVNN-gx2WFdKbPVW-PB","data":[],"key":"onEbvS7a2a"}],"key":"sby6Py3Cvp"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create virtual datasets for every file in the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"S4V95opnW1"},{"type":"inlineCode","value":"File_Pattern","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DiCsmPGZX0"},{"type":"text","value":" list","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eMN7Rro2o0"}],"identifier":"create-virtual-datasets-for-every-file-in-the-file-pattern-list","label":"Create virtual datasets for every file in the File_Pattern list","html_id":"create-virtual-datasets-for-every-file-in-the-file-pattern-list","implicit":true,"key":"YRDTkIOiJA"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now that we have a list of NetCDF files, we can use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"AlqntxvA6X"},{"type":"inlineCode","value":"VirtualiZarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Qlp0D5oYYr"},{"type":"text","value":" to create virtual datasets for each one of these.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TFr7o74bNG"}],"key":"PYHmGxH9YS"}],"key":"RgL4jWbaHY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define kwargs for ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Yyo0lAukoY"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JMvplKYunL"}],"identifier":"define-kwargs-for-fsspec","label":"Define kwargs for fsspec","html_id":"define-kwargs-for-fsspec","implicit":true,"key":"SqGD8pKhwM"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In the cell below, we are creating a dictionary of ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"HhIrrvvoms"},{"type":"inlineCode","value":"kwargs","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"pXgZ06aFzt"},{"type":"text","value":" to pass to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"EEzaB9exWo"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"rqX0yYWyka"},{"type":"text","value":" and the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"qWBMNgdOt7"},{"type":"inlineCode","value":"s3","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"xKAebF67vA"},{"type":"text","value":" filesystem. Details on this can be found in the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"aekANXLyXD"},{"type":"link","url":"/notebooks/foundations/kerchunk-basics","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Basics of virtual Zarr stores tutorial","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"RzrkGBkIsX"}],"urlSource":"./01_kerchunk_basics.ipynb","dataUrl":"/notebooks.foundations.kerchunk-basics.json","internal":true,"protocol":"file","key":"KKBa41qJ9P"},{"type":"text","value":" in the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"JZWTSQKbtt"},{"type":"strong","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Define storage_options arguments","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"Qme7u72uIN"}],"key":"Z8Paho13w1"},{"type":"text","value":" section","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"ClQrHYIEo2"}],"key":"A6PCsgoqI9"}],"key":"Ezrumjzzwp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"storage_options = dict(anon=True, default_fill_cache=False, default_cache_type=\"none\")","key":"MtJpMJ9o6l"},{"type":"output","id":"8pXPFBZCJL4mPZRFvPXV_","data":[],"key":"b2h8T5MhV4"}],"key":"Lmmpf4Uv1q"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In the cell below, we are reusing some of the functionality from the previous tutorial.\nFirst we are defining a function named: ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kfzkdAMlGH"},{"type":"inlineCode","value":"generate_json_reference","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jB28s50Z4j"},{"type":"text","value":".\nThis function:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"N9ZRGiMIUx"}],"key":"Ee8Hcv7Igh"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Uses an ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"LwErEOaCj4"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"JsBE9WkEQF"},{"type":"text","value":" ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"TkSGnbbsCf"},{"type":"inlineCode","value":"s3","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"qYoTM0lgfs"},{"type":"text","value":" filesystem to read in a ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"RIOZwuwCzB"},{"type":"inlineCode","value":"NetCDF","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Ela9BLhGaR"},{"type":"text","value":" from a given url.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"S3z8f3Yhmr"}],"key":"cfa02tlDXA"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Generates a ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"E478sxR9nt"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"J5oV6iMs62"},{"type":"text","value":" index using the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"JBYqDnuHMd"},{"type":"inlineCode","value":"SingleHdf5ToZarr","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"P0PYhiv8kt"},{"type":"text","value":" ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Fxq5Mwst2n"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"vNqgMeLegv"},{"type":"text","value":" method.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QmdJ2iqsDU"}],"key":"NLPNcuyPo9"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Creates a simplified filename using some string slicing.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Lbiwr0FoMR"}],"key":"gKR1hmJIPl"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Uses the local filesystem created with ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"MQoOCagsuA"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"biP6TpvmWI"},{"type":"text","value":" to write the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"SCtQSTVWxX"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"N8M95V6Aa9"},{"type":"text","value":" index to a ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"yC3Ya8CXcK"},{"type":"inlineCode","value":".json","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"cV99z1xnSS"},{"type":"text","value":" reference file.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"e37uYhdkDX"}],"key":"O4k5Cu2WlE"}],"key":"ME1EYMIy7i"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Below the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"XhmIdWhc7Z"},{"type":"inlineCode","value":"generate_json_reference","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"WTQrYOkvJL"},{"type":"text","value":" function we created, we have a simple ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"lsdJm5fJXo"},{"type":"inlineCode","value":"for","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"l683Z3RdsS"},{"type":"text","value":" loop that iterates through our list of ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"GIm4xvF9ma"},{"type":"inlineCode","value":"NetCDF","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"KHGRG8S2H1"},{"type":"text","value":" file urls and passes them to our ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"fKsFMNe4sa"},{"type":"inlineCode","value":"generate_json_reference","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"WXAjQ0E0Uf"},{"type":"text","value":" function, which appends the name of each ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"UCHL09srzo"},{"type":"inlineCode","value":".json","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ALqj6YQw3V"},{"type":"text","value":" reference file to a list named ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"BU2xaMNa3H"},{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"output_files","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"rcdyeH61xE"}],"key":"SFPq7P8mDi"},{"type":"text","value":".","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"ocDjijMTuy"}],"key":"PjA8Io2tX5"}],"key":"hwP4hjGqgn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"virtual_datasets = [\n    open_virtual_dataset(\n        filepath, indexes={}, reader_options={\"storage_options\": storage_options}\n    )\n    for filepath in files_paths\n]","key":"O4x6vWQ9gK"},{"type":"output","id":"5yz3JZPEXB93CDT16Te1B","data":[],"key":"rvyCkPTQeu"}],"key":"vzGIDdYSIf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combine virtual datasets","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dFpfaZmlly"}],"identifier":"combine-virtual-datasets","label":"Combine virtual datasets","html_id":"combine-virtual-datasets","implicit":true,"key":"YSkEFkPRNf"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"After we have generated a virtual dataset for each ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ofhtdl7xW2"},{"type":"inlineCode","value":"NetCDF","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mzvw1QVcwv"},{"type":"text","value":" file, we can combine these into a single virtual dataset using Xarray’s ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CkzEHJkgjx"},{"type":"inlineCode","value":"combine_nested","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NR21DDMi7C"},{"type":"text","value":" function.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dMmYMFcinC"}],"key":"SqMKaJI8Br"}],"key":"KxFlXgNm7w"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"combined_vds = xr.combine_nested(\n    virtual_datasets, concat_dim=[\"Time\"], coords=\"minimal\", compat=\"override\"\n)\ncombined_vds","key":"gVZjkQnUVz"},{"type":"output","id":"MszQup65ggZeDJw38msGz","data":[],"key":"fR7pF9ClQf"}],"key":"Rx1GoCJxVn"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Write combined virtual dataset to a Kerchunk JSON for future use","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pYWFX5Eo4y"}],"identifier":"write-combined-virtual-dataset-to-a-kerchunk-json-for-future-use","label":"Write combined virtual dataset to a Kerchunk JSON for future use","html_id":"write-combined-virtual-dataset-to-a-kerchunk-json-for-future-use","implicit":true,"key":"QWxoPHsIrM"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"If we want to keep the combined reference information in memory as well as write the file to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"OaXGk5wYGG"},{"type":"inlineCode","value":".json","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"m9TD7DBY2E"},{"type":"text","value":", we can run the code snippet below.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"hhopQsXlpd"}],"key":"iASjwokbtC"}],"key":"caMvBlgyHQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Write kerchunk .json record\noutput_fname = \"combined_kerchunk.json\"\ncombined_vds.virtualize.to_kerchunk(output_fname, format=\"json\")","key":"gichtEDcmK"},{"type":"output","id":"i1lWk00AcNgZwVwP-pMbb","data":[],"key":"Ek1r1R01Fg"}],"key":"oM2HLPwMGs"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Using the output","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lNj1zBIhcg"}],"identifier":"using-the-output","label":"Using the output","html_id":"using-the-output","implicit":true,"key":"NUO0r1CJP4"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now that we have built a virtual dataset using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TyRKWg1B0V"},{"type":"inlineCode","value":"VirtualiZarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"U08cWQSavI"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YBhBHlWUce"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"REUCPhQ06f"},{"type":"text","value":", we can read all of those original ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vLhumx16GD"},{"type":"inlineCode","value":"NetCDF","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"aKH31iau7l"},{"type":"text","value":" files as if they were a single ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qAsRYTULkF"},{"type":"inlineCode","value":"Zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bstj1gh4fN"},{"type":"text","value":" dataset.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qkGJOlE0D2"}],"key":"ZckzQkchnJ"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"**Since we saved the combined virtual dataset, this work doesn’t have to be repeated for anyone else to use this dataset. All they need is to pass the reference file storing the virtual dataset to ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"HsiG8q770I"},{"type":"inlineCode","value":"Xarray","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"qWrETFQlQl"},{"type":"text","value":" and it is as if they had a ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"doGwet5ccm"},{"type":"inlineCode","value":"Zarr","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"fJJVobsMfg"},{"type":"text","value":" dataset!","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"n2xrxQnjWt"}],"key":"JKdQfZ5PcK"}],"key":"LubX1C476l"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Open combined virtual dataset with Kerchunk","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FuYb6Lialt"}],"identifier":"open-combined-virtual-dataset-with-kerchunk","label":"Open combined virtual dataset with Kerchunk","html_id":"open-combined-virtual-dataset-with-kerchunk","implicit":true,"key":"SDLbEs25bR"}],"key":"Zwb0EVyqAO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# We once again need to provide information for fsspec to access the remote file\nstorage_options = dict(\n    remote_protocol=\"s3\", remote_options=dict(anon=True), skip_instance_cache=True\n)\n# We will use the \"kerchunk\" engine in `xr.open_dataset` and pass the `storage_options` to the `kerchunk` engine through `backend_kwargs`\nds = xr.open_dataset(\n    output_fname,\n    engine=\"kerchunk\",\n    backend_kwargs={\"storage_options\": storage_options},\n)\nds","key":"wrb1SDC1U7"},{"type":"output","id":"wMbbtF1Rr8Ms11cmgF26z","data":[],"key":"uBtxnL3A68"}],"key":"GSjDfpJLLP"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plot a slice of the dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qwV2AWdU5t"}],"identifier":"plot-a-slice-of-the-dataset","label":"Plot a slice of the dataset","html_id":"plot-a-slice-of-the-dataset","implicit":true,"key":"ygqH04Z77w"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Here we are using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Gj4Mjv3IMO"},{"type":"inlineCode","value":"Xarray","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zjfyufHXPg"},{"type":"text","value":" to select a single time slice of the dataset and plot a map of snow cover over South East Alaska.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"rPU5chNSg8"}],"key":"d371rLH9w2"}],"key":"WAtCVq67kJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds.isel(Time=0).SNOW.plot()","key":"NH3vna4etB"},{"type":"output","id":"5yP1Uydj7gxklOdjXxLiM","data":[],"key":"GDqZ3BZGbo"}],"key":"h99JBlWmfU"}],"key":"hr2HnWeJUv"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Basics of virtual Zarr stores","url":"/notebooks/foundations/kerchunk-basics","group":"Foundations"},"next":{"title":"Parallel virtual dataset creation with VirtualiZarr, Kerchunk, and Dask","url":"/notebooks/foundations/kerchunk-dask","group":"Foundations"}}},"domain":"http://localhost:3000"}
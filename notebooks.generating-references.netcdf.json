{"version":2,"kind":"Notebook","sha256":"e06211f94405aadb11307b4a910d5914bbacc4b4ee3331e38ad0923113ee7047","slug":"notebooks.generating-references.netcdf","location":"/notebooks/generating_references/NetCDF.ipynb","dependencies":[],"frontmatter":{"title":"NetCDF","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"kerchunk-cookbook","language":"python"},"authors":[{"nameParsed":{"literal":"Norland Raphael Hagen","given":"Norland Raphael","family":"Hagen"},"name":"Norland Raphael Hagen","id":"contributors-myst-generated-uid-0"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/kerchunk-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/kerchunk-cookbook/blob/main/notebooks/generating_references/NetCDF.ipynb","thumbnail":"/kerchunk-cookbook/build/ARG-e095d6164434aaac073f50d89dea79d9.png","exports":[{"format":"ipynb","filename":"NetCDF.ipynb","url":"/kerchunk-cookbook/build/NetCDF-e491986f89f239589ab2acba0d5bb329.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Generating virtual datasets from NetCDF files","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"uKh55Roh3o"}],"key":"JHTpfGaIbt"}],"key":"yGQUk2DaSQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"image","url":"/kerchunk-cookbook/build/ARG-e095d6164434aaac073f50d89dea79d9.png","alt":"ARG","width":350,"key":"Qlk2jsxpjV","urlSource":"../images/ARG.png"}],"key":"XaDfvSvR2e"}],"key":"FKYDfYfKJ3"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"e24YAHhVOj"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"lY2rFpj05L"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Within this notebook, we will cover:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Z4mpjCrFoE"}],"key":"NON6V52twD"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"How to access remote NetCDF data using ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"BlB0pdc5FR"},{"type":"inlineCode","value":"VirtualiZarr","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"FMCoVDlZiE"},{"type":"text","value":" and ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ED3lk5uzSV"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"zyMsGbFa0X"}],"key":"YEvwIdVvXi"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Combining multiple virtual datasets","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"lpO231Sxfc"}],"key":"WOUzSmJRlf"}],"key":"VdlY30RLUD"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"This notebook shares many similarities with the  ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"qzDaTBczGi"},{"type":"link","url":"./02_kerchunk_multi_file.ipynb","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"multi-file virtual datasets with VirtualiZarr","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"i08ZN7qDPI"}],"urlSource":"./02_kerchunk_multi_file.ipynb","key":"nExxUKZB44"},{"type":"text","value":" notebook. If you are confused on the function of a block of code, please refer there for a more detailed breakdown of what each line is doing.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"VC2CVLmlRT"}],"key":"zwzf9LGHEa"},{"type":"heading","depth":2,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"GyCI8zphpi"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"TspozCLdCR"},{"type":"table","position":{"start":{"line":12,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"ZEqzBcdeLo"}],"key":"q71eojzTBM"},{"type":"tableCell","header":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"eIFV1DN8X3"}],"key":"BbTkGUReET"},{"type":"tableCell","header":true,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"jD0Ya4ECVQ"}],"key":"Oq74KM5KMW"}],"key":"CC3uDWfIjh"},{"type":"tableRow","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"link","url":"/notebooks/foundations/kerchunk-basics","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Basics of virtual Zarr stores","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"pVQmZwiQVt"}],"urlSource":"../foundations/01_kerchunk_basics.ipynb","dataUrl":"/notebooks.foundations.kerchunk-basics.json","internal":true,"protocol":"file","key":"wazgGfRGsA"}],"key":"tDnyesJDJo"},{"type":"tableCell","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"sPcOdGLgNe"}],"key":"bCwOGwQgG7"},{"type":"tableCell","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"KsE8T3lr7t"}],"key":"kpkFYQcF9y"}],"key":"x6Ht9gFXIv"},{"type":"tableRow","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"link","url":"/notebooks/foundations/kerchunk-multi-file","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Multi-file virtual datasets with VirtualiZarr","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"wshK9hAAJK"}],"urlSource":"../foundations/02_kerchunk_multi_file.ipynb","dataUrl":"/notebooks.foundations.kerchunk-multi-file.json","internal":true,"protocol":"file","key":"JFMss9rBVq"}],"key":"blZBklC6OK"},{"type":"tableCell","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"NDfgTZ6u5L"}],"key":"oDTD2h9Kpx"},{"type":"tableCell","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"poQlODDsX1"}],"key":"ZoCukHgAYK"}],"key":"MlW61UiAEj"},{"type":"tableRow","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"link","url":"/notebooks/foundations/kerchunk-dask","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Parallel virtual dataset creation with VirtualiZarr, Kerchunk, and Dask","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"FbeR6ysmAa"}],"urlSource":"../foundations/03_kerchunk_dask","dataUrl":"/notebooks.foundations.kerchunk-dask.json","internal":true,"protocol":"file","key":"Nom1Lmcfgr"}],"key":"Om5ZPzywWr"},{"type":"tableCell","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"RiRCRtDxDU"}],"key":"cp7Gasnnui"},{"type":"tableCell","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Core","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"AqPpJk0KXJ"}],"key":"BqQxNvkiWx"}],"key":"NGfU1OWrLG"},{"type":"tableRow","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray/xarray-intro.html","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Introduction to Xarray","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"KleWP8f1DS"}],"urlSource":"https://foundations.projectpythia.org/core/xarray/xarray-intro.html","key":"erOdHDdvGs"}],"key":"hSSfHUC19p"},{"type":"tableCell","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Required","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"Tk3CmAiHQ7"}],"key":"daLsn2nOgM"},{"type":"tableCell","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"IO/Visualization","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"pUENE6ruwi"}],"key":"KGl3ZWKYZE"}],"key":"G2a681wsRn"}],"key":"S4SayKE4zF"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"strong","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"NnvIkEgjrl"}],"key":"whO0QZCc0g"},{"type":"text","value":": 45 minutes","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"V4N27EbwbF"}],"key":"iQew8TKrYE"}],"key":"XbNTqzPVTp"},{"type":"thematicBreak","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"bAtax75yK3"}],"key":"PwZgk2wu0S"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Motivation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"utGrKbjbbH"}],"identifier":"motivation","label":"Motivation","html_id":"motivation","implicit":true,"key":"DESYBOjh1t"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"NetCDF4/HDF5 is one of the most universally adopted file formats in earth sciences, with support of much of the community as well as scientific agencies, data centers and university labs. A huge amount of legacy data has been generated in this format. Fortunately, using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CveuE85e7U"},{"type":"inlineCode","value":"VirtualiZarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xRiBlwfZOx"},{"type":"text","value":" and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FlH2hLFNXw"},{"type":"inlineCode","value":"Kerchunk","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ib1TB7l6Zw"},{"type":"text","value":", we can read these datasets as if they were an Analysis-Read Cloud-Optimized (ARCO) format such as ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GnZtou7TA7"},{"type":"inlineCode","value":"Zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yBwlzdgZfQ"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"EIot8fjpv3"}],"key":"xtF1gh0fHh"}],"key":"eR1XCa6zS6"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"About the Dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OQ8rT4DInp"}],"identifier":"about-the-dataset","label":"About the Dataset","html_id":"about-the-dataset","implicit":true,"key":"vyPaXIEvKw"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"For this example, we will look at a weather dataset composed of multiple NetCDF files.The SMN-Arg is a WRF deterministic weather forecasting dataset created by the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MMjXlIJqVk"},{"type":"inlineCode","value":"Servicio Meteorológico Nacional de Argentina","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"R97zyTmdey"},{"type":"text","value":" that covers Argentina as well as many neighboring countries at a 4km spatial resolution.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DvOliij6wb"}],"key":"J20cJe01O5"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"The model is initialized twice daily at 00 & 12 UTC with hourly forecasts for variables such as temperature, relative humidity, precipitation, wind direction and magnitude etc. for multiple atmospheric levels.\nThe data is output at hourly intervals with a maximum prediction lead time of 72 hours in NetCDF files.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GnQgHLt2Qp"}],"key":"IMpq1TL4lS"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"More details on this dataset can be found ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"H4KzvsOAgG"},{"type":"link","url":"https://registry.opendata.aws/smn-ar-wrf-dataset/","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"here","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"dGr0qig26I"}],"urlSource":"https://registry.opendata.aws/smn-ar-wrf-dataset/","key":"rLYUIhPZwf"},{"type":"text","value":".","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Nurt9J3Spr"}],"key":"gJVHRmNbHu"}],"key":"bQJs5AeSUN"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Flags","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LpYnBGBMUS"}],"identifier":"flags","label":"Flags","html_id":"flags","implicit":true,"key":"a5plXWKRxX"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In the section below, set the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"QdUoDFkMkQ"},{"type":"inlineCode","value":"subset","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"j1VdzIN7gF"},{"type":"text","value":" flag to be ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"wYlBUxaT6v"},{"type":"inlineCode","value":"True","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"DuKoK0vuQz"},{"type":"text","value":" (default) or ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"nUXQ8VOX7W"},{"type":"inlineCode","value":"False","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"amH0lpJRNY"},{"type":"text","value":" depending if you want this notebook to process the full file list. If set to ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"P1tKrL7ann"},{"type":"inlineCode","value":"True","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"mZ6UC60sEt"},{"type":"text","value":", then a subset of the file list will be processed (Recommended)","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"jU6CQDywNX"}],"key":"xK7EpszBVg"}],"key":"vp6NxJ69yO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"subset_flag = True","key":"P5AGcfjknR"},{"type":"output","id":"uW3uoMAVKykgTZ-rypjkE","data":[],"key":"LNTbceERGj"}],"key":"WjIrlXJIJC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oHm5u7Jrnd"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"thWu4JzT0e"}],"key":"vyOBUr0ukJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import logging\n\nimport dask\nimport fsspec\nimport s3fs\nimport xarray as xr\nfrom distributed import Client\nfrom virtualizarr import open_virtual_dataset","key":"rlj6VZMbdS"},{"type":"output","id":"_hDVtRdFaWHf4C5uehDr1","data":[],"key":"w6ydlPzvmR"}],"key":"FtKLdgph6m"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Examining a Single NetCDF File","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FOg1Km2ZV2"}],"identifier":"examining-a-single-netcdf-file","label":"Examining a Single NetCDF File","html_id":"examining-a-single-netcdf-file","implicit":true,"key":"rXxbrjXzJp"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Before we use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"AAwW4n93pJ"},{"type":"inlineCode","value":"VirtualiZarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"apqu6VN8eG"},{"type":"text","value":" to create virtual datasets for multiple files, we can load a single NetCDF file to examine it.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nZliNOo5t7"}],"key":"uQXjmSN7VH"}],"key":"gW9rvtQugC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# URL pointing to a single NetCDF file\nurl = \"s3://smn-ar-wrf/DATA/WRF/DET/2022/12/31/00/WRFDETAR_01H_20221231_00_072.nc\"\n\n# Initialize a s3 filesystem\nfs = s3fs.S3FileSystem(anon=True)\n# Use Xarray to open a remote NetCDF file\nds = xr.open_dataset(fs.open(url), engine=\"h5netcdf\")","key":"wN4UtOR4tj"},{"type":"output","id":"9pvIsp1Mrwt89fv8clBfg","data":[],"key":"uAJTNfsw7u"}],"key":"HQe1lNSC10"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Here we see the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ypWmwHlHz0"},{"type":"inlineCode","value":"repr","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"B5RNnqQkx2"},{"type":"text","value":" from the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GQ2hf6toqj"},{"type":"inlineCode","value":"Xarray","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GWwGNGBumQ"},{"type":"text","value":" Dataset of a single ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"w0M8U8YI5y"},{"type":"inlineCode","value":"NetCDF","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xgxaOFpvgi"},{"type":"text","value":" file. From examining the output, we can tell that the Dataset dimensions are ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pIb2CHGPXF"},{"type":"inlineCode","value":"['time','y','x']","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NyY961CpGV"},{"type":"text","value":", with time being only a single step.\nLater, when we use ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WSxHiWocbH"},{"type":"inlineCode","value":"Xarray's","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"e6Rm6nx4Gm"},{"type":"text","value":" ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y5HcgErc6E"},{"type":"inlineCode","value":"combine_nested","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JnSZBj7QOi"},{"type":"text","value":" functionality, we will need to know on which dimensions to concatenate across.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BnWdTgqAwy"}],"key":"UhLarfouCa"}],"key":"mX1idpHYyB"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create Input File List","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"T09fDD3t1X"}],"identifier":"create-input-file-list","label":"Create Input File List","html_id":"create-input-file-list","implicit":true,"key":"qGwfKUKMfm"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Here we are using ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ke362SW4WX"},{"type":"inlineCode","value":"fsspec's","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nIvVAsuVlI"},{"type":"text","value":" glob functionality along with the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vuOkJ4VUjv"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"*","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hI0P2JVx7E"}],"key":"i9WfDhkUKy"},{"type":"text","value":" wildcard operator and some string slicing to grab a list of NetCDF files from a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jOvedmFtKS"},{"type":"inlineCode","value":"s3","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BSJLEmyYP5"},{"type":"text","value":" ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XXhC1LQa1Z"},{"type":"inlineCode","value":"fsspec","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zoht74VOpt"},{"type":"text","value":" filesystem.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TNGA7XBMyE"}],"key":"l9XJlG0gHQ"}],"key":"BJALErSOqy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Initiate fsspec filesystems for reading\nfs_read = fsspec.filesystem(\"s3\", anon=True, skip_instance_cache=True)\n\nfiles_paths = fs_read.glob(\"s3://smn-ar-wrf/DATA/WRF/DET/2022/12/31/12/*\")\n\n# Here we prepend the prefix 's3://', which points to AWS.\nfiles_paths = sorted([\"s3://\" + f for f in files_paths])\n\n\n# If the subset_flag == True (default), the list of input files will be subset\n# to speed up the processing\nif subset_flag:\n    files_paths = files_paths[0:8]","key":"YSaMCRyADS"},{"type":"output","id":"GvhEMHxGzT72PctzM2VWo","data":[],"key":"qU4HrgxqcS"}],"key":"qZL3Tp469u"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Start a Dask Client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xkDzfQMXUZ"}],"identifier":"start-a-dask-client","label":"Start a Dask Client","html_id":"start-a-dask-client","implicit":true,"key":"Glib5pDiRG"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To parallelize the creation of our reference files, we will use ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NxL23xtdmp"},{"type":"inlineCode","value":"Dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"d1KHtCm0wD"},{"type":"text","value":". For a detailed guide on how to use Dask and Kerchunk, see the Foundations notebook: ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"iEltaeFpN7"},{"type":"link","url":"../foundations/kerchunk_dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Kerchunk and Dask","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yCIJyKxdX7"}],"urlSource":"../foundations/kerchunk_dask","key":"Fw9IkZkjAT"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qOl8QgrS5O"}],"key":"fLQF88vFS0"}],"key":"Mz2qqvUzV4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client = Client(n_workers=8, silence_logs=logging.ERROR)\nclient","key":"M3UsH0Yhki"},{"type":"output","id":"m-QxBWx1GGcVTb6gAWmzc","data":[{"output_type":"stream","name":"stderr","text":"/home/runner/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/distributed/node.py:187: UserWarning: Port 8787 is already in use.\nPerhaps you already have a cluster running?\nHosting the HTTP server on port 42405 instead\n  warnings.warn(\n"},{"output_type":"execute_result","execution_count":5,"metadata":{},"data":{"text/plain":{"content":"<Client: 'tcp://127.0.0.1:37297' processes=8 threads=8, memory=15.62 GiB>","content_type":"text/plain"},"text/html":{"content":"<div>\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\"> </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px;\">Client</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Client-951eecc4-5f83-11f0-9091-7c1e52865385</p>\n        <table style=\"width: 100%; text-align: left;\">\n\n        <tr>\n        \n            <td style=\"text-align: left;\"><strong>Connection method:</strong> Cluster object</td>\n            <td style=\"text-align: left;\"><strong>Cluster type:</strong> distributed.LocalCluster</td>\n        \n        </tr>\n\n        \n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:42405/status\" target=\"_blank\">http://127.0.0.1:42405/status</a>\n                </td>\n                <td style=\"text-align: left;\"></td>\n            </tr>\n        \n\n        </table>\n\n        \n            <button style=\"margin-bottom: 12px;\" data-commandlinker-command=\"dask:populate-and-launch-layout\" data-commandlinker-args='{\"url\": \"http://127.0.0.1:42405/status\" }'>\n                Launch dashboard in JupyterLab\n            </button>\n        \n\n        \n            <details>\n            <summary style=\"margin-bottom: 20px;\"><h3 style=\"display: inline;\">Cluster Info</h3></summary>\n            <div class=\"jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output\">\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\">\n    </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px; margin-top: 0px;\">LocalCluster</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">537be561</p>\n        <table style=\"width: 100%; text-align: left;\">\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:42405/status\" target=\"_blank\">http://127.0.0.1:42405/status</a>\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Workers:</strong> 8\n                </td>\n            </tr>\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Total threads:</strong> 8\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Total memory:</strong> 15.62 GiB\n                </td>\n            </tr>\n            \n            <tr>\n    <td style=\"text-align: left;\"><strong>Status:</strong> running</td>\n    <td style=\"text-align: left;\"><strong>Using processes:</strong> True</td>\n</tr>\n\n            \n        </table>\n\n        <details>\n            <summary style=\"margin-bottom: 20px;\">\n                <h3 style=\"display: inline;\">Scheduler Info</h3>\n            </summary>\n\n            <div style=\"\">\n    <div>\n        <div style=\"width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;\"> </div>\n        <div style=\"margin-left: 48px;\">\n            <h3 style=\"margin-bottom: 0px;\">Scheduler</h3>\n            <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Scheduler-636a417d-390c-410d-b2ed-f6f63ab77990</p>\n            <table style=\"width: 100%; text-align: left;\">\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Comm:</strong> tcp://127.0.0.1:37297\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Workers:</strong> 0 \n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:42405/status\" target=\"_blank\">http://127.0.0.1:42405/status</a>\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total threads:</strong> 0\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Started:</strong> Just now\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total memory:</strong> 0 B\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n\n    <details style=\"margin-left: 48px;\">\n        <summary style=\"margin-bottom: 20px;\">\n            <h3 style=\"display: inline;\">Workers</h3>\n        </summary>\n\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 0</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:43285\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:37883/status\" target=\"_blank\">http://127.0.0.1:37883/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:33023\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-t4uauxkz\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 1</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:42881\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:35499/status\" target=\"_blank\">http://127.0.0.1:35499/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:34411\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-mmnb65kb\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 2</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:46177\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:43151/status\" target=\"_blank\">http://127.0.0.1:43151/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:44963\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-03u2q421\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 3</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:32811\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:37269/status\" target=\"_blank\">http://127.0.0.1:37269/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:43989\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-sok_sogg\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 4</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:43115\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:35871/status\" target=\"_blank\">http://127.0.0.1:35871/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:38701\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-9lfxxm32\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 5</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:36523\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:46745/status\" target=\"_blank\">http://127.0.0.1:46745/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:42403\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-742x9n3u\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 6</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:33465\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:36087/status\" target=\"_blank\">http://127.0.0.1:36087/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:43983\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-_w360hs6\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 7</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:43787\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:34391/status\" target=\"_blank\">http://127.0.0.1:34391/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 1.95 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:45145\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-o0tu1xnx\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n\n    </details>\n</div>\n\n        </details>\n    </div>\n</div>\n            </details>\n        \n\n    </div>\n</div>","content_type":"text/html"}}}],"key":"HKZK26MnyJ"}],"key":"qNr11EnG79"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def generate_virtual_dataset(file, storage_options):\n    return open_virtual_dataset(\n        file, indexes={}, reader_options={\"storage_options\": storage_options}\n    )\n\n\nstorage_options = dict(anon=True, default_fill_cache=False, default_cache_type=\"none\")\n# Generate Dask Delayed objects\ntasks = [\n    dask.delayed(generate_virtual_dataset)(file, storage_options)\n    for file in files_paths\n]","key":"ZvsODexESJ"},{"type":"output","id":"1RHYrrn1uegvEzouQfqoM","data":[],"key":"fOMeqwnJvB"}],"key":"vWXs0tXD4P"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Start parallel processing\nimport warnings\n\nwarnings.filterwarnings(\"ignore\")\nvirtual_datasets = list(dask.compute(*tasks))","key":"U5cPf3rFlE"},{"type":"output","id":"IKkkK3pnUQ9ZuoJzRkAkh","data":[],"key":"amf8J7UDjV"}],"key":"NKUS82DZ6v"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combine virtual datasets and write a Kerchunk reference JSON to store the virtual Zarr store","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dOTdEQIlRF"}],"identifier":"combine-virtual-datasets-and-write-a-kerchunk-reference-json-to-store-the-virtual-zarr-store","label":"Combine virtual datasets and write a Kerchunk reference JSON to store the virtual Zarr store","html_id":"combine-virtual-datasets-and-write-a-kerchunk-reference-json-to-store-the-virtual-zarr-store","implicit":true,"key":"vaVrzBgr1l"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In the following cell, we are combining all the `virtual datasets that were generated above into a single reference file and writing that file to disk.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"iVOqaHDbN0"}],"key":"uLxmOB2cJR"}],"key":"BNIV2mLYhh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"combined_vds = xr.combine_nested(\n    virtual_datasets, concat_dim=[\"time\"], coords=\"minimal\", compat=\"override\"\n)\ncombined_vds","key":"aoCVlEYjas"},{"type":"output","id":"zM4M7jmgEgF5LBWwP2GBb","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mValueError\u001b[39m                                Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[8]\u001b[39m\u001b[32m, line 1\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m1\u001b[39m combined_vds = \u001b[43mxr\u001b[49m\u001b[43m.\u001b[49m\u001b[43mcombine_nested\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      2\u001b[39m \u001b[43m    \u001b[49m\u001b[43mvirtual_datasets\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mconcat_dim\u001b[49m\u001b[43m=\u001b[49m\u001b[43m[\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mtime\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m=\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mminimal\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m=\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43moverride\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\n\u001b[32m      3\u001b[39m \u001b[43m)\u001b[49m\n\u001b[32m      4\u001b[39m combined_vds\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/structure/combine.py:588\u001b[39m, in \u001b[36mcombine_nested\u001b[39m\u001b[34m(datasets, concat_dim, compat, data_vars, coords, fill_value, join, combine_attrs)\u001b[39m\n\u001b[32m    585\u001b[39m     concat_dim = [concat_dim]\n\u001b[32m    587\u001b[39m \u001b[38;5;66;03m# The IDs argument tells _nested_combine that datasets aren't yet sorted\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m588\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43m_nested_combine\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    589\u001b[39m \u001b[43m    \u001b[49m\u001b[43mdatasets\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    590\u001b[39m \u001b[43m    \u001b[49m\u001b[43mconcat_dims\u001b[49m\u001b[43m=\u001b[49m\u001b[43mconcat_dim\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    591\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    592\u001b[39m \u001b[43m    \u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    593\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    594\u001b[39m \u001b[43m    \u001b[49m\u001b[43mids\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m    595\u001b[39m \u001b[43m    \u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m=\u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    596\u001b[39m \u001b[43m    \u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m=\u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    597\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    598\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/structure/combine.py:367\u001b[39m, in \u001b[36m_nested_combine\u001b[39m\u001b[34m(datasets, concat_dims, compat, data_vars, coords, ids, fill_value, join, combine_attrs)\u001b[39m\n\u001b[32m    364\u001b[39m _check_shape_tile_ids(combined_ids)\n\u001b[32m    366\u001b[39m \u001b[38;5;66;03m# Apply series of concatenate or merge operations along each dimension\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m367\u001b[39m combined = \u001b[43m_combine_nd\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    368\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcombined_ids\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    369\u001b[39m \u001b[43m    \u001b[49m\u001b[43mconcat_dims\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    370\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    371\u001b[39m \u001b[43m    \u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    372\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    373\u001b[39m \u001b[43m    \u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m=\u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    374\u001b[39m \u001b[43m    \u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m=\u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    375\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    376\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    377\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m combined\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/structure/combine.py:246\u001b[39m, in \u001b[36m_combine_nd\u001b[39m\u001b[34m(combined_ids, concat_dims, data_vars, coords, compat, fill_value, join, combine_attrs)\u001b[39m\n\u001b[32m    242\u001b[39m \u001b[38;5;66;03m# Each iteration of this loop reduces the length of the tile_ids tuples\u001b[39;00m\n\u001b[32m    243\u001b[39m \u001b[38;5;66;03m# by one. It always combines along the first dimension, removing the first\u001b[39;00m\n\u001b[32m    244\u001b[39m \u001b[38;5;66;03m# element of the tuple\u001b[39;00m\n\u001b[32m    245\u001b[39m \u001b[38;5;28;01mfor\u001b[39;00m concat_dim \u001b[38;5;129;01min\u001b[39;00m concat_dims:\n\u001b[32m--> \u001b[39m\u001b[32m246\u001b[39m     combined_ids = \u001b[43m_combine_all_along_first_dim\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    247\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcombined_ids\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    248\u001b[39m \u001b[43m        \u001b[49m\u001b[43mdim\u001b[49m\u001b[43m=\u001b[49m\u001b[43mconcat_dim\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    249\u001b[39m \u001b[43m        \u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    250\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    251\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    252\u001b[39m \u001b[43m        \u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m=\u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    253\u001b[39m \u001b[43m        \u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m=\u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    254\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    255\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    256\u001b[39m (combined_ds,) = combined_ids.values()\n\u001b[32m    257\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m combined_ds\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/structure/combine.py:278\u001b[39m, in \u001b[36m_combine_all_along_first_dim\u001b[39m\u001b[34m(combined_ids, dim, data_vars, coords, compat, fill_value, join, combine_attrs)\u001b[39m\n\u001b[32m    276\u001b[39m     combined_ids = \u001b[38;5;28mdict\u001b[39m(\u001b[38;5;28msorted\u001b[39m(group))\n\u001b[32m    277\u001b[39m     datasets = combined_ids.values()\n\u001b[32m--> \u001b[39m\u001b[32m278\u001b[39m     new_combined_ids[new_id] = \u001b[43m_combine_1d\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    279\u001b[39m \u001b[43m        \u001b[49m\u001b[43mdatasets\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mdim\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcombine_attrs\u001b[49m\n\u001b[32m    280\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    281\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m new_combined_ids\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/structure/combine.py:301\u001b[39m, in \u001b[36m_combine_1d\u001b[39m\u001b[34m(datasets, concat_dim, compat, data_vars, coords, fill_value, join, combine_attrs)\u001b[39m\n\u001b[32m    299\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m concat_dim \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m    300\u001b[39m     \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m301\u001b[39m         combined = \u001b[43mconcat\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    302\u001b[39m \u001b[43m            \u001b[49m\u001b[43mdatasets\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    303\u001b[39m \u001b[43m            \u001b[49m\u001b[43mdim\u001b[49m\u001b[43m=\u001b[49m\u001b[43mconcat_dim\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    304\u001b[39m \u001b[43m            \u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    305\u001b[39m \u001b[43m            \u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    306\u001b[39m \u001b[43m            \u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    307\u001b[39m \u001b[43m            \u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m=\u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    308\u001b[39m \u001b[43m            \u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m=\u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    309\u001b[39m \u001b[43m            \u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    310\u001b[39m \u001b[43m        \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    311\u001b[39m     \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m \u001b[38;5;28;01mas\u001b[39;00m err:\n\u001b[32m    312\u001b[39m         \u001b[38;5;28;01mif\u001b[39;00m \u001b[33m\"\u001b[39m\u001b[33mencountered unexpected variable\u001b[39m\u001b[33m\"\u001b[39m \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mstr\u001b[39m(err):\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/structure/concat.py:277\u001b[39m, in \u001b[36mconcat\u001b[39m\u001b[34m(objs, dim, data_vars, coords, compat, positions, fill_value, join, combine_attrs, create_index_for_new_dim)\u001b[39m\n\u001b[32m    264\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m _dataarray_concat(\n\u001b[32m    265\u001b[39m         objs,\n\u001b[32m    266\u001b[39m         dim=dim,\n\u001b[32m   (...)\u001b[39m\u001b[32m    274\u001b[39m         create_index_for_new_dim=create_index_for_new_dim,\n\u001b[32m    275\u001b[39m     )\n\u001b[32m    276\u001b[39m \u001b[38;5;28;01melif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(first_obj, Dataset):\n\u001b[32m--> \u001b[39m\u001b[32m277\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43m_dataset_concat\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    278\u001b[39m \u001b[43m        \u001b[49m\u001b[43mobjs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    279\u001b[39m \u001b[43m        \u001b[49m\u001b[43mdim\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdim\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    280\u001b[39m \u001b[43m        \u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdata_vars\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    281\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcoords\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    282\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcompat\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    283\u001b[39m \u001b[43m        \u001b[49m\u001b[43mpositions\u001b[49m\u001b[43m=\u001b[49m\u001b[43mpositions\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    284\u001b[39m \u001b[43m        \u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m=\u001b[49m\u001b[43mfill_value\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    285\u001b[39m \u001b[43m        \u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m=\u001b[49m\u001b[43mjoin\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    286\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    287\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcreate_index_for_new_dim\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcreate_index_for_new_dim\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    288\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    289\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m    290\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mTypeError\u001b[39;00m(\n\u001b[32m    291\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33mcan only concatenate xarray Dataset and DataArray \u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m    292\u001b[39m         \u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mobjects, got \u001b[39m\u001b[38;5;132;01m{\u001b[39;00m\u001b[38;5;28mtype\u001b[39m(first_obj)\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m\n\u001b[32m    293\u001b[39m     )\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/structure/concat.py:676\u001b[39m, in \u001b[36m_dataset_concat\u001b[39m\u001b[34m(datasets, dim, data_vars, coords, compat, positions, fill_value, join, combine_attrs, create_index_for_new_dim)\u001b[39m\n\u001b[32m    674\u001b[39m         result_vars[k] = v\n\u001b[32m    675\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m676\u001b[39m     combined_var = \u001b[43mconcat_vars\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    677\u001b[39m \u001b[43m        \u001b[49m\u001b[38;5;28;43mvars\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mdim_name\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mpositions\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcombine_attrs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcombine_attrs\u001b[49m\n\u001b[32m    678\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    679\u001b[39m     \u001b[38;5;66;03m# reindex if variable is not present in all datasets\u001b[39;00m\n\u001b[32m    680\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mlen\u001b[39m(variable_index) < concat_index_size:\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/core/variable.py:3023\u001b[39m, in \u001b[36mconcat\u001b[39m\u001b[34m(variables, dim, positions, shortcut, combine_attrs)\u001b[39m\n\u001b[32m   2975\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mconcat\u001b[39m(\n\u001b[32m   2976\u001b[39m     variables,\n\u001b[32m   2977\u001b[39m     dim=\u001b[33m\"\u001b[39m\u001b[33mconcat_dim\u001b[39m\u001b[33m\"\u001b[39m,\n\u001b[32m   (...)\u001b[39m\u001b[32m   2980\u001b[39m     combine_attrs=\u001b[33m\"\u001b[39m\u001b[33moverride\u001b[39m\u001b[33m\"\u001b[39m,\n\u001b[32m   2981\u001b[39m ):\n\u001b[32m   2982\u001b[39m \u001b[38;5;250m    \u001b[39m\u001b[33;03m\"\"\"Concatenate variables along a new or existing dimension.\u001b[39;00m\n\u001b[32m   2983\u001b[39m \n\u001b[32m   2984\u001b[39m \u001b[33;03m    Parameters\u001b[39;00m\n\u001b[32m   (...)\u001b[39m\u001b[32m   3021\u001b[39m \u001b[33;03m        along the given dimension.\u001b[39;00m\n\u001b[32m   3022\u001b[39m \u001b[33;03m    \"\"\"\u001b[39;00m\n\u001b[32m-> \u001b[39m\u001b[32m3023\u001b[39m     variables = \u001b[38;5;28;43mlist\u001b[39;49m\u001b[43m(\u001b[49m\u001b[43mvariables\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   3024\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mall\u001b[39m(\u001b[38;5;28misinstance\u001b[39m(v, IndexVariable) \u001b[38;5;28;01mfor\u001b[39;00m v \u001b[38;5;129;01min\u001b[39;00m variables):\n\u001b[32m   3025\u001b[39m         \u001b[38;5;28;01mreturn\u001b[39;00m IndexVariable.concat(variables, dim, positions, shortcut, combine_attrs)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/structure/concat.py:598\u001b[39m, in \u001b[36m_dataset_concat.<locals>.ensure_common_dims\u001b[39m\u001b[34m(vars, concat_dim_lengths)\u001b[39m\n\u001b[32m    596\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m var.dims != common_dims:\n\u001b[32m    597\u001b[39m     common_shape = \u001b[38;5;28mtuple\u001b[39m(dims_sizes.get(d, dim_len) \u001b[38;5;28;01mfor\u001b[39;00m d \u001b[38;5;129;01min\u001b[39;00m common_dims)\n\u001b[32m--> \u001b[39m\u001b[32m598\u001b[39m     var = \u001b[43mvar\u001b[49m\u001b[43m.\u001b[49m\u001b[43mset_dims\u001b[49m\u001b[43m(\u001b[49m\u001b[43mcommon_dims\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcommon_shape\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    599\u001b[39m \u001b[38;5;28;01myield\u001b[39;00m var\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/util/deprecation_helpers.py:143\u001b[39m, in \u001b[36mdeprecate_dims.<locals>.wrapper\u001b[39m\u001b[34m(*args, **kwargs)\u001b[39m\n\u001b[32m    135\u001b[39m     emit_user_level_warning(\n\u001b[32m    136\u001b[39m         \u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mThe `\u001b[39m\u001b[38;5;132;01m{\u001b[39;00mold_name\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m` argument has been renamed to `dim`, and will be removed \u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m    137\u001b[39m         \u001b[33m\"\u001b[39m\u001b[33min the future. This renaming is taking place throughout xarray over the \u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m   (...)\u001b[39m\u001b[32m    140\u001b[39m         \u001b[38;5;167;01mPendingDeprecationWarning\u001b[39;00m,\n\u001b[32m    141\u001b[39m     )\n\u001b[32m    142\u001b[39m     kwargs[\u001b[33m\"\u001b[39m\u001b[33mdim\u001b[39m\u001b[33m\"\u001b[39m] = kwargs.pop(old_name)\n\u001b[32m--> \u001b[39m\u001b[32m143\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43mfunc\u001b[49m\u001b[43m(\u001b[49m\u001b[43m*\u001b[49m\u001b[43margs\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/xarray/core/variable.py:1401\u001b[39m, in \u001b[36mVariable.set_dims\u001b[39m\u001b[34m(self, dim, shape)\u001b[39m\n\u001b[32m   1394\u001b[39m \u001b[38;5;28;01melif\u001b[39;00m shape \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m \u001b[38;5;129;01mor\u001b[39;00m \u001b[38;5;28mall\u001b[39m(\n\u001b[32m   1395\u001b[39m     s == \u001b[32m1\u001b[39m \u001b[38;5;28;01mfor\u001b[39;00m s, e \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mzip\u001b[39m(shape, dim, strict=\u001b[38;5;28;01mTrue\u001b[39;00m) \u001b[38;5;28;01mif\u001b[39;00m e \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;129;01min\u001b[39;00m self_dims\n\u001b[32m   1396\u001b[39m ):\n\u001b[32m   1397\u001b[39m     \u001b[38;5;66;03m# \"Trivial\" broadcasting, i.e. simply inserting a new dimension\u001b[39;00m\n\u001b[32m   1398\u001b[39m     \u001b[38;5;66;03m# This is typically easier for duck arrays to implement\u001b[39;00m\n\u001b[32m   1399\u001b[39m     \u001b[38;5;66;03m# than the full \"broadcast_to\" semantics\u001b[39;00m\n\u001b[32m   1400\u001b[39m     indexer = (\u001b[38;5;28;01mNone\u001b[39;00m,) * (\u001b[38;5;28mlen\u001b[39m(expanded_dims) - \u001b[38;5;28mself\u001b[39m.ndim) + (...,)\n\u001b[32m-> \u001b[39m\u001b[32m1401\u001b[39m     expanded_data = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mdata\u001b[49m\u001b[43m[\u001b[49m\u001b[43mindexer\u001b[49m\u001b[43m]\u001b[49m\n\u001b[32m   1402\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:  \u001b[38;5;66;03m# elif shape is not None:\u001b[39;00m\n\u001b[32m   1403\u001b[39m     dims_map = \u001b[38;5;28mdict\u001b[39m(\u001b[38;5;28mzip\u001b[39m(dim, shape, strict=\u001b[38;5;28;01mTrue\u001b[39;00m))\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/kerchunk-cookbook/lib/python3.13/site-packages/virtualizarr/manifests/array.py:215\u001b[39m, in \u001b[36mManifestArray.__getitem__\u001b[39m\u001b[34m(self, key)\u001b[39m\n\u001b[32m    212\u001b[39m indexer = _possibly_expand_trailing_ellipsis(key, \u001b[38;5;28mself\u001b[39m.ndim)\n\u001b[32m    214\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mlen\u001b[39m(indexer) != \u001b[38;5;28mself\u001b[39m.ndim:\n\u001b[32m--> \u001b[39m\u001b[32m215\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\n\u001b[32m    216\u001b[39m         \u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mInvalid indexer for array with ndim=\u001b[39m\u001b[38;5;132;01m{\u001b[39;00m\u001b[38;5;28mself\u001b[39m.ndim\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mindexer\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m\n\u001b[32m    217\u001b[39m     )\n\u001b[32m    219\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mall\u001b[39m(\n\u001b[32m    220\u001b[39m     \u001b[38;5;28misinstance\u001b[39m(axis_indexer, \u001b[38;5;28mslice\u001b[39m) \u001b[38;5;129;01mand\u001b[39;00m axis_indexer == \u001b[38;5;28mslice\u001b[39m(\u001b[38;5;28;01mNone\u001b[39;00m)\n\u001b[32m    221\u001b[39m     \u001b[38;5;28;01mfor\u001b[39;00m axis_indexer \u001b[38;5;129;01min\u001b[39;00m indexer\n\u001b[32m    222\u001b[39m ):\n\u001b[32m    223\u001b[39m     \u001b[38;5;66;03m# indexer is all slice(None)'s, so this is a no-op\u001b[39;00m\n\u001b[32m    224\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28mself\u001b[39m\n\n\u001b[31mValueError\u001b[39m: Invalid indexer for array with ndim=0: (None,)","ename":"ValueError","evalue":"Invalid indexer for array with ndim=0: (None,)"}],"key":"yY2QX0gNDy"}],"key":"B8cplKPob7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"combined_vds.virtualize.to_kerchunk(\"ARG_combined.json\", format=\"json\")","key":"TGBCsDS2wg"},{"type":"output","id":"kmKqb3vym-1FNL19PzaUr","data":[],"key":"j7oP6dYZT9"}],"key":"E4BGSMIZsJ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Shut down the Dask cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m1Dhjad8Rn"}],"identifier":"shut-down-the-dask-cluster","label":"Shut down the Dask cluster","html_id":"shut-down-the-dask-cluster","implicit":true,"key":"vqf9xnD4yi"}],"key":"rwM2km1LqD"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.shutdown()","key":"YzObPYHbmn"},{"type":"output","id":"2l1u1OuRDvx664vHGG1u7","data":[],"key":"DkWCQFt4K5"}],"key":"jXmSGVTD2s"}],"key":"A7FrKFV6Wb"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Appending to Kerchunk references","url":"/notebooks/advanced/appending","group":"Advanced"},"next":{"title":"GRIB2","url":"/notebooks/generating-references/grib2","group":"Generating Reference Files"}}},"domain":"http://localhost:3000"}